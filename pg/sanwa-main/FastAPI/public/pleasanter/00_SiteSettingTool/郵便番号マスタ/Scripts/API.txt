let API_VERSION = "1.0"

/**
 * 取得APIを呼び出す関数です。
 *
 * @param {Number}    id テーブルID
 * @param {Array}     columns 取得列
 * @param {Object}    filterHash フィルター条件
 * @param {Object}    sorterHash ソート条件
 * @param {Object}    filterSearchTypes 検索条件
 * @param {Boolean}   valueFlg true : value値 false : display値
 * @param {Function}  addFunc 最後に実行したい関数
 */
async function commonGetData(id = $p.siteId(), columns = ["ClassA", "NumA"], filterHash = {}, sorterHash = { "ResultId": "asc" }, filterSearchTypes = {}, valueFlg = true, addFunc) {
    if (!Array.isArray(columns)) {
        columns = [columns]
    }
    let offset = 0
    let data = []
    let temp = {}
    do {
        temp = await commonGetInnner(id, columns, filterHash, sorterHash, filterSearchTypes, valueFlg, offset, addFunc)
        data = [...data, ...temp.Response.Data]
        offset += temp.Response.PageSize
    } while (offset < temp.Response.TotalCount)
    return data

    /**
     * 取得APIを呼び出す関数内関数です。(TotalCount 200)
     *
     * @param {Number}    id テーブルID
     * @param {Array}     columns 取得列
     * @param {Object}    filterHash フィルター条件
     * @param {Object}    sorterHash ソート条件
     * @param {Object}    filterSearchTypes 検索条件
     * @param {Boolean}   valueFlg true : value値 false : display値
     * @param {Number}    offset オフセット条件
     * @param {Function}  addFunc 最後に実行したい関数
     */
    async function commonGetInnner(id, columns, filterHash, sorterHash, filterSearchTypes, valueFlg, offset, addFunc) {
        return await $p.apiGet({
            'id': id,
            'data': {
                'Offset': offset,
                'View': {
                    'ApiDataType': "KeyValues",
                    'ApiColumnValueDisplayType': valueFlg ? "Value" : "DisplayValue",
                    'GridColumns': columns,
                    "ColumnFilterHash": filterHash,
                    "ColumnSorterHash": sorterHash,
                    "ColumnFilterSearchTypes": filterSearchTypes,
                }
            },
            'done': function (data) {
                if (addFunc && typeof addFunc === 'function') {
                    // 渡されたオブジェクトが関数なら実行する
                    addFunc(data)
                }
                return data.Response.Data
            }
        })
    }
}

/**
 * エクスポートAPIを呼び出す関数です。
 *
 * @param {String}    tableId 取得テーブルID
 * @param {Array}     columns 取得列
 * @param {Object}    filterHash フィルター条件
 * @param {Object}    sorterHash ソート条件
 * @param {Object}    filterSearchTypes 検索条件
 * @param {Boolean}   jsonFlg trueならjson　falseならcsvで取得
 * @param {Boolean}   headerFlg trueならheaderも取得
 * @param {Boolean}   overFlg trueなら超過分のみ取得
 * @param {Function}  addFunc 最後に実行したい関数
 */
async function commonExportData(tableId = $p.siteId(), columns = ["ClassA", "NumA"], filterHash = {}, sorterHash = {"ResultId": "asc"}, filterSearchTypes = {}, jsonFlg = true, headerFlg = true, overFlg = false, addFunc) {
    if (!Array.isArray(columns)) {
        columns = [columns]
    }
        columns.unshift("ResultId")
    let data = await commonExportInner(tableId, columns, filterHash, sorterHash, filterSearchTypes, jsonFlg, headerFlg, overFlg, addFunc)
    if (jsonFlg) {
        // json整形
        data = JSON.parse(data.Response.Content)
    } else {
        // csv整形
        data = commonConvertCsvTo2D(data.Response.Content)
    }

    return data
    /**
     * エクスポートAPIを呼び出す関数内関数です。
     *
     * @param {String}    tableId 取得テーブルID
     * @param {Array}     columns 取得列
     * @param {Object}    filterHash フィルター条件
     * @param {Object}    sorterHash ソート条件
     * @param {Object}    filterSearchTypes 検索条件
     * @param {Boolean}   jsonFlg trueならjson　falseならcsvで取得
     * @param {Boolean}   headerFlg trueならheaderも取得
     * @param {Boolean}   overFlg trueなら超過分のみ取得
     * @param {Function}  addFunc 最後に実行したい関数
     */
    async function commonExportInner(tableId, columns, filterHash, sorterHash, filterSearchTypes, jsonFlg, headerFlg, overFlg, addFunc) {

        let col = []
        columns.forEach(v => col.push({ "ColumnName": v }))
        let data = JSON.stringify({
            "ApiVersion": API_VERSION ,
            "Export": {
                "Columns": col,
                "Header": headerFlg,
                "Type": jsonFlg ? "json" : "csv"
            },
            "View": {
                "Overdue": overFlg,
                "ColumnFilterHash": filterHash,
                "ColumnSorterHash": sorterHash,
                "ColumnFilterSearchTypes": filterSearchTypes,
            }
        })

        return new Promise((resolve, reject) => {
            $.ajax({
                type: "POST",
                url: `/api/items/${tableId}/export`,
                contentType: 'application/json',
                data: data
            }).then(
                function (result) {
                    if (addFunc && typeof addFunc === 'function') {
                        // 渡されたオブジェクトが関数なら実行する
                        addFunc(data)
                    }
                    // 正常終了
                    resolve(result)
                },
                function () {
                    // エラー
                    reject()
                }
            )
        })
    }
}

/**
 * 登録APIを呼び出す関数です。
 *
 * @param {String}    tableId 登録テーブルID
 * @param {Object}    Hash 更新項目
 * @param {String}    Status 登録ステータス
 * @param {String}    Comments 登録コメント
 * @param {Boolean}   pushFlg updated_idsに（default）pushする
 * @param {Function}  addFunc 最後に実行したい関数
 */
async function commonCreate(tableId, Hash = {}, Status, Comments, pushFlg = true, addFunc) {

    // 登録項目
    let ClassHash = {}
    let NumHash = {}
    let DateHash = {}
    let DescriptionHash = {}
    let CheckHash = {}
    for (let key in Hash) {
        if (key.includes("Class")) ClassHash[key] = Hash[key]
        else if (key.includes("Num")) NumHash[key] = commonConvertCTo1(Hash[key])
        else if (key.includes("Date")) DateHash[key] = commonIsNull(Hash[key]) ? commonGetDateEmpty() : Hash[key]
        else if (key.includes("Description")) DescriptionHash[key] = Hash[key]
        else if (key.includes("Check")) CheckHash[key] = Hash[key]
    }

    let data = JSON.stringify({
        "ApiVersion": API_VERSION ,
        Status,
        Comments,
        ClassHash,
        NumHash,
        DateHash,
        DescriptionHash,
        CheckHash
    })
    if (!commonIsNull(Status)) {
        delete data["Status"]
    }
    if (!commonIsNull(Comments)) {
        delete data["Comments"]
    }

    return new Promise((resolve, reject) => {
        $.ajax({
            type: "POST",
            url: `/api/items/${tableId}/create`,
            contentType: 'application/json',
            data: data
        }).then(
            function (result) {
                if (addFunc && typeof addFunc === 'function') {
                    // 渡されたオブジェクトが関数なら実行する
                    addFunc(data)
                }
                if (pushFlg) {
                    created_ids.push(result.Id)
                    created_ids = [...new Set(created_ids.map(v => String(v)))]
                }
                // 正常終了
                resolve(result)
            },
            function () {
                // エラー
                reject()
            }
        )
    })
}

/**
 * 更新APIを呼び出す関数です。
 *
 * @param {String}    recordId 更新レコードID
 * @param {Object}    Hash 更新項目
 * @param {String}    Status 更新ステータス
 * @param {String}    Comments 更新コメント
 * @param {Boolean}   pushFlg created_idsに（default）pushする
 * @param {Function}  addFunc 最後に実行したい関数
 */
async function commonUpdate(recordId, Hash = {}, Status, Comments, pushFlg = true, addFunc) {

    // 更新項目
    let ClassHash = {}
    let NumHash = {}
    let DateHash = {}
    let DescriptionHash = {}
    let CheckHash = {}
    for (let key in Hash) {
        if (key.includes("Class")) ClassHash[key] = Hash[key]
        else if (key.includes("Num")) NumHash[key] = commonConvertCTo1(Hash[key])
        else if (key.includes("Date")) DateHash[key] = commonIsNull(Hash[key]) ? commonGetDateEmpty() : Hash[key]
        else if (key.includes("Description")) DescriptionHash[key] = Hash[key]
        else if (key.includes("Check")) CheckHash[key] = Hash[key]
    }
    let data = JSON.stringify({
        "ApiVersion": API_VERSION ,
        Status,
        Comments,
        ClassHash,
        NumHash,
        DateHash,
        DescriptionHash,
        CheckHash
    })
    if (!commonIsNull(Status)) {
        delete data["Status"]
    }
    if (!commonIsNull(Comments)) {
        delete data["Comments"]
    }

    return new Promise((resolve, reject) => {
        $.ajax({
            type: "POST",
            url: `/api/items/${recordId}/update`,
            contentType: 'application/json',
            data: data
        }).then(
            function (result) {
                if (addFunc && typeof addFunc === 'function') {
                    // 渡されたオブジェクトが関数なら実行する
                    addFunc(data)
                }
                if (pushFlg) {
                    updated_ids.push(result.Id)
                    updated_ids = [...new Set(updated_ids.map(v => String(v)))]
                }

                // 正常終了
                resolve(result)
            },
            function () {
                // エラー
                reject()
            }
        )
    })
}

/**
 * ユーザー取得APIを呼び出す関数です。
 *
 * @param {Array}     userIds 取得UserId
 * @param {Function}  addFunc 最後に実行したい関数
 */
async function commonExportUser(userIds, addFunc) {
    let users = []
    if (Array.isArray(userIds)) {
        users = userIds
    } else {
        users = [userIds]
    }
    let data = JSON.stringify({
        "ApiVersion": API_VERSION ,
        "View": {
            "ColumnFilterHash": {
                "UserId": JSON.stringify(users)
            }
        }
    })
    return new Promise((resolve, reject) => {
        $.ajax({
            type: "POST",
            url: "/api/users/get",
            contentType: 'application/json',
            data: data
        }).then(
            function (result) {
                if (addFunc && typeof addFunc === 'function') {
                    // 渡されたオブジェクトが関数なら実行する
                    addFunc(data)
                }
                // 正常終了
                resolve(result)
            },
            function () {
                // エラー
                reject()
            }
        )
    })
}

/**
 * グループ取得APIを呼び出す関数です。
 *
 * @param {Array}     groupIds 取得GroupId
 * @param {Function}  addFunc 最後に実行したい関数
 */
async function commonExportGroup(groupIds, addFunc) {
    let groups = []
    if (Array.isArray(groupIds)) {
        groups = groupIds
    } else {
        groups = [groupIds]
    }
    let data = JSON.stringify({
        "ApiVersion": API_VERSION ,
        "View": {
            "ColumnFilterHash": {
                "GroupId": JSON.stringify(groups)
            }
        }
    })
    return new Promise((resolve, reject) => {
        $.ajax({
            type: "POST",
            url: "/api/groups/get",
            contentType: 'application/json',
            data: data
        }).then(
            function (result) {
                if (addFunc && typeof addFunc === 'function') {
                    // 渡されたオブジェクトが関数なら実行する
                    addFunc(data)
                }
                // 正常終了
                resolve(result)
            },
            function () {
                // エラー
                reject()
            }
        )
    })
}

/**
 * レコード複製を行う関数です。（編集画面で使用を想定）
 *
 * @param {Object}    editItems 変更項目
 * @param {String}    Status 登録ステータス
 * @param {String}    Comments 登録コメント
 * @param {Number}    expand 最大拡張項目数
 * @param {Function}  addFunc 最後に実行したい関数
 */
async function commonCopyRecord(editItems = {}, Status, Comments, expand = 0, addFunc) {

    try {
        if ($p.action() !== "edit") {
            let message = STATUS_ERROR_MESSAGE_EDIT
            commonMessage(message, STATUS_ERROR)
            throw new Error(message)
        }

        let Hash = {}

        //項目Aから項目Z
        let alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"
        for (let char of alphabet) {
            let clsKey = "Class" + char
            let numKey = "Num" + char
            let datKey = "Date" + char
            let dscKey = "Description" + char
            let chkKey = "Check" + char
            Hash[clsKey] = commonIsNull(commonGetVal(clsKey)) ? "" : (Array.isArray(commonGetVal(clsKey, true)) ? convertArrayToMalti(commonGetVal(clsKey, true)) : commonGetVal(clsKey, true))
            Hash[numKey] = commonIsNull(commonGetVal(numKey)) ? 0 : commonConvertCTo1(commonGetVal(numKey))
            Hash[datKey] = commonIsNull(commonGetVal(datKey)) ? commonGetDateEmpty() : commonGetVal(datKey)
            Hash[dscKey] = commonIsNull(commonGetVal(dscKey)) ? "" : commonGetVal(dscKey)
            Hash[chkKey] = commonIsNull(commonGetVal(chkKey)) ? false : commonGetVal(chkKey)
        }

        //項目001から項目999
        for (let i = 1; i <= expand; i++) {
            let clsKey = "Class" + String(i).padStart(3, "0")
            let numKey = "Num" + String(i).padStart(3, "0")
            let datKey = "Date" + String(i).padStart(3, "0")
            let dscKey = "Description" + String(i).padStart(3, "0")
            let chkKey = "Check" + String(i).padStart(3, "0")
            Hash[clsKey] = commonIsNull(commonGetVal(clsKey)) ? "" : (Array.isArray(commonGetVal(clsKey, true)) ? convertArrayToMalti(commonGetVal(clsKey, true)) : commonGetVal(clsKey, true))
            Hash[numKey] = commonIsNull(commonGetVal(numKey)) ? 0 : commonConvertCTo1(commonGetVal(numKey))
            Hash[datKey] = commonIsNull(commonGetVal(datKey)) ? commonGetDateEmpty() : commonGetVal(datKey)
            Hash[dscKey] = commonIsNull(commonGetVal(dscKey)) ? "" : commonGetVal(dscKey)
            Hash[chkKey] = commonIsNull(commonGetVal(chkKey)) ? false : commonGetVal(chkKey)
        }

        // 変更項目を上書き
        for (let key in editItems) {
            Hash[key] = editItems[key]
        }

        // ステータスを取得
        if (commonIsNull(Status)) {
            Status = commonGetVal("Status", true)
        }

        return commonCreate(
            $p.siteId()
            , Hash
            , Status
            , Comments
            , addFunc
        )
    } catch (err) {
        // 再スロー
        throw err
    }
}

/**
 * レコード保存を行う関数です。（編集画面で使用を想定）
 *
 * @param {Object}    editItems 変更項目
 * @param {String}    Status 更新ステータス
 * @param {String}    Comments 更新コメント
 * @param {Boolean}   reload リロードするかどうか
 * @param {Number}    expand 最大拡張項目数
 * @param {Function}  addFunc 最後に実行したい関数
 */
async function commonSaveRecord(editItems = {}, Status, Comments, reload = false, expand = 0, addFunc) {

    try {
        if ($p.action() !== "edit") {
            let message = STATUS_ERROR_MESSAGE_EDIT
            commonMessage(message, STATUS_ERROR)
            throw new Error(message)
        }

        let Hash = {}

        //項目Aから項目Z
        let alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"
        for (let char of alphabet) {
            let clsKey = "Class" + char
            let numKey = "Num" + char
            let datKey = "Date" + char
            let dscKey = "Description" + char
            let chkKey = "Check" + char
            Hash[clsKey] = commonIsNull(commonGetVal(clsKey)) ? "" : (Array.isArray(commonGetVal(clsKey, true)) ? convertArrayToMalti(commonGetVal(clsKey, true)) : commonGetVal(clsKey, true))
            Hash[numKey] = commonIsNull(commonGetVal(numKey)) ? 0 : commonConvertCTo1(commonGetVal(numKey))
            Hash[datKey] = commonIsNull(commonGetVal(datKey)) ? commonGetDateEmpty() : commonGetVal(datKey)
            Hash[dscKey] = commonIsNull(commonGetVal(dscKey)) ? "" : commonGetVal(dscKey)
            Hash[chkKey] = commonIsNull(commonGetVal(chkKey)) ? false : commonGetVal(chkKey)
        }

        //項目001から項目999
        for (let i = 1; i <= expand; i++) {
            let clsKey = "Class" + String(i).padStart(3, "0")
            let numKey = "Num" + String(i).padStart(3, "0")
            let datKey = "Date" + String(i).padStart(3, "0")
            let dscKey = "Description" + String(i).padStart(3, "0")
            let chkKey = "Check" + String(i).padStart(3, "0")
            Hash[clsKey] = commonIsNull(commonGetVal(clsKey)) ? "" : (Array.isArray(commonGetVal(clsKey, true)) ? convertArrayToMalti(commonGetVal(clsKey, true)) : commonGetVal(clsKey, true))
            Hash[numKey] = commonIsNull(commonGetVal(numKey)) ? 0 : commonConvertCTo1(commonGetVal(numKey))
            Hash[datKey] = commonIsNull(commonGetVal(datKey)) ? commonGetDateEmpty() : commonGetVal(datKey)
            Hash[dscKey] = commonIsNull(commonGetVal(dscKey)) ? "" : commonGetVal(dscKey)
            Hash[chkKey] = commonIsNull(commonGetVal(chkKey)) ? false : commonGetVal(chkKey)
        }

        // 変更項目を上書き
        for (let key in editItems) {
            Hash[key] = editItems[key]
        }

        // ステータスを取得
        if (commonIsNull(Status)) {
            Status = commonGetVal("Status", true)
        }

        let u = await commonUpdate(
            $p.id()
            , Hash
            , Status
            , Comments
            , addFunc
        )
        if (reload) {
            $(window).off('beforeunload');
            location.reload()
        }
        return u
    } catch (err) {
        // 再スロー
        throw err
    }

}
/**
 * 添付項目にExcelを添付し更新する共通関数です。
 *
 * @param {string} targetID 更新対象のアイテムID
 * @param {string} className 添付ファイルのクラス名
 * @param {Object} excel Excelワークブックオブジェクト
 * @param {string} filename 添付ファイルの名前
 */
async function commonUpdateExcel(targetID, className, workbook, filename) {
    const fileBuffer = await workbook.xlsx.writeBuffer()
    const base64 = commonGetBufferToBase64(fileBuffer)

    let url = `/api/items/${targetID}/update`
    let method_name = "POST"
    let data = {
        "ApiVersion": API_VERSION ,
        "AttachmentsHash": {
            [className]: [
                {
                    "ContentType": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    "Name": filename,
                    "Base64": base64
                }
            ]
        }
    }
    await $.ajax({
        type: method_name,
        url: url,
        data: JSON.stringify(data),
        contentType: 'application/json',
        dataType: 'json',
        scriptCharset: 'utf-8',
        success: function (data) {
            // Success
            console.log("success")
            console.log(JSON.stringify(data))
        },
        error: function (data) {
            // Error
            console.log("error")
            console.log(JSON.stringify(data))
        }
    })
}

function commonGetBufferToBase64(buffer) {
    let binary
    let bytes = new Uint8Array(buffer)
    for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i])
    }
    return window.btoa(binary)
}
