let newData = {};

// model から必要なフィールドを抽出してnewDataにセット
for (let key in model) {
    if (model.hasOwnProperty(key)) {
        newData[key] = model[key];
        // 日付型はJSTに修正する
        if (key.indexOf('Date') !== -1) {
            newData[key] = model[key].toLocaleString("ja-JP", {timeZone: "JST"});
        }
    }
}

//担当者CD、支払区分CDを実データに修正
try {
    let n_results1 = items.Get(model['ClassN']);
    newData['ClassN'] = n_results1[0]['NumB'];
} catch(e) {
    newData['ClassN'] = '';
}
try {
    let n_results2 = items.Get(model['ClassX']);
    newData['ClassX'] = n_results2[0]['NumA'];
} catch(e) {
    newData['ClassX'] = '';
}

// 送信するパラメータをオブジェクトで定義
let data = {}
data.pleasanter_table_name = context.SiteTitle;
data.new_data = newData;


// オブジェクトをJSON文字列に変換して、Contentプロパティにセット
httpClient.Content = JSON.stringify(data);

httpClient.Encoding = "utf-8";
httpClient.MediaType = "application/json";

// FastAPI サーバーのエンドポイントを指定
httpClient.RequestUri = "http://localhost:8000/sync-record/create";

try{
    // POST メソッドでリクエストを送信する
    let response = httpClient.Post();

    // レスポンスの結果をチェックする
    if (!httpClient.IsSuccess) {
        // エラーの場合、ステータスコードとレスポンス内容をログに出力し、例外を発生させる
        context.AddMessage("Error: 【" + httpClient.StatusCode + "】 " + response, "alert-error");
        throw new Error("HTTPリクエストに失敗しました。以降の処理を中断します。");
    }
} catch (e) {
    items.Delete(model['ResultId']);
    context.Error("実行処理がエラーとなりました。登録内容をご確認ください。");
    context.Log(e.stack);
}