# 光熱費管理Excelファイル役割分析 説明書

## 📋 概要

双日ライフワン株式会社の光熱費管理システムにおける各Excelファイルの役割、ファイル間の関係性、および月次業務フローを詳細に分析しました。

**作成日**: 2025-07-09
**対象ファイル数**: 5つのExcelファイル

---

## 🗂️ 分析対象ファイル一覧

| ファイル名 | 役割 | VBAマクロ | ファイルサイズ | 更新頻度 |
|-----------|------|----------|-------------|---------|
| **管理変動費(YYYYMM).xls** | 月次光熱費データ保管 | ❌ なし | 約600KB | 月次 |
| **計算用管理変動費Master.xls** | データ統合・計算処理 | ✅ あり | 590KB | 月次 |
| **MO報告光熱費.xls** | 報告書生成・データ処理 | ✅ あり | 1.1MB | 月次 |
| **検針結果出力ファイル.xlsx** | 検針生データ入力 | ❌ なし | 227KB | 月次 |
| **CSVデータ群** | 外部システム連携 | - | 各種 | 月次 |

---

## 🔍 各ファイルの詳細分析

### 1. 管理変動費(YYYYMM).xls - 月次データアーカイブ

#### 📊 基本情報
- **ファイルの目的**: 各月の光熱費データを保管する最終成果物
- **作成タイミング**: 毎月月初（前月データ確定後）
- **バージョン管理**: ファイル名に年月（YYYYMM）を含む

#### 🗂️ シート構成（全10シート）

| シート名 | データ内容 | 行数 | 主要項目 |
|---------|-----------|-----|---------|
| 電気使用料(一般) | 一般電気使用量・料金 | 約250行 | テナント名、使用量、単価、金額 |
| 電気使用料(動力-店舗内) | 店舗内動力電気 | 約250行 | テナント名、使用量、単価、金額 |
| 電気使用料(動力-空調用) | 空調用動力電気 | 約250行 | テナント名、使用量、単価、金額 |
| 電気使用料(合計) | 電気料金集計 | 約250行 | テナント別電気料金合計 |
| 空調用ガス使用料 | ガス使用量・料金 | 約250行 | テナント名、使用量、単価、金額 |
| 水道使用料 | 水道使用量・料金 | 約250行 | テナント名、使用量、単価、金額 |
| 駐車サービス券_1140 | 駐車券管理（1140） | 約220行 | テナント名、枚数、金額 |
| 駐車サービス券_1150 | 駐車券管理（1150） | 約16行 | テナント名、枚数、金額 |
| システム利用料 | システム費用配賦 | 約220行 | テナント名、配賦額 |
| Sheet2 | 未使用 | 0行 | - |

#### 💡 重要な特徴
- **VBAマクロなし**: 純粋なデータ保管用ファイル
- **データ固定**: 値のみ保存（数式なし）
- **履歴管理**: 過去データの参照・比較用

---

### 2. 計算用管理変動費Master.xls - 中央処理エンジン

#### 📊 基本情報
- **ファイルの目的**: 各種データの統合・計算・転送処理
- **役割**: データ処理のハブ（中継点）
- **VBAマクロ**: 4つの主要機能を実装

#### 🗂️ シート構成（全8シート）

| シート名 | データ内容 | 特記事項 |
|---------|-----------|---------|
| 電気使用料(一般) | 計算用電気データ | E列：今月値、I列：前月値、L-M列：前年値 |
| 電気使用料(動力-店舗内) | 計算用動力データ | 同上の列構成 |
| 電気使用料(動力-空調用) | 計算用空調電気 | 同上の列構成 |
| 電気使用料(合計) | 電気合計計算 | 各種電気の合計処理 |
| 空調用ガス使用料 | 計算用ガスデータ | E列：今月値、I列：前月値 |
| 水道使用料 | 計算用水道データ | E列：今月値、I列：前月値 |
| 光熱水使用量 | 使用量サマリー | 集計データ |
| 光熱水使用量 (2) | 使用量サマリー2 | 別形式の集計 |

#### 🎯 VBAマクロ機能

##### 1. **FDに値のコピー** (Module1 - 150行)
```
処理フロー:
1. 各シートのE列（今月データ）を選択
2. 管理変動費Master.xlsを開く
3. 対応するシートにデータをペースト
4. 値のみ貼り付けで確定
```

##### 2. **管理変動費master用FD作成** (Module3 - 194行)
```
処理フロー:
1. E列（今月）、I列（前月）、L-M列（前年）を順次コピー
2. 管理変動費Master.xlsの各シートに転送
3. 5つのシート（電気3種、ガス、水道）を一括処理
```

##### 3. **電気合計チェック** (Module5 - 46行)
```
処理フロー:
1. ユーザー確認ダイアログ表示
2. 管理変動費Master.xlsの電気合計データ取得
3. 計算用ファイルに転記
4. 整合性確認
```

##### 4. **Macro_test_1** (Module4 - 20行)
```
処理フロー:
1. H2:H19範囲のデータコピー
2. A:\管理変動費Master.xlsを開く
3. データ貼り付け（テスト用途）
```

#### 💡 重要な特徴
- **データ集約点**: 各種ソースからのデータを一元管理
- **計算処理**: 前月比・前年比などの計算実行
- **転送ハブ**: 最終的な管理変動費ファイルへの橋渡し

---

### 3. MO報告光熱費.xls - 業務処理・報告書生成

#### 📊 基本情報
- **ファイルの目的**: データ入力・加工・報告書作成の統合環境
- **役割**: 業務オペレーションの中心
- **VBAマクロ**: 21個の機能（最も複雑）

#### 🗂️ シート構成（全10シート）

| シート名 | データ内容 | 用途 |
|---------|-----------|-----|
| 集計計算の説明 | 操作マニュアル | 業務手順の説明 |
| 入力操作用シート | メインメニュー | マクロ実行ボタン配置 |
| JM報告（電気） | 電気使用量報告 | 電気データ集計・報告 |
| 空調料金按分 | 空調費用配賦 | 複雑な按分計算 |
| JM報告（一般ガス水道） | ガス・水道報告 | ガス水道データ集計 |
| テナント検針 | 検針データ入力 | CSVインポート先 |
| 店名リスト | マスターデータ | テナント情報管理 |
| 5期空調按分 | 期別空調配賦 | 特別な按分処理 |
| 分電盤番号 | 設備マスター | 電気系統管理 |
| 入力操作用シート (旧) | 旧バージョン | 互換性維持用 |

#### 🎯 主要VBAマクロ機能（重要度順）

##### 1. **テナント検針データコピー** (Module1内)
```
処理内容:
- CSVファイル（テナント検針.csv）の読み込み
- 大量データ（400行以上）の一括取り込み
- テナント検針シートへの貼り付け
```

##### 2. **準備1～3** (Module1, 9, 12)
```
準備1: JM報告（一般ガス水道）の前月データ固定化
準備2: JM報告（電気）のデータ準備
準備3: 統合的なデータ準備処理
```

##### 3. **空調料金按分処理** (Module5, 6, 7)
```
- 空調使用量の按分計算
- 各テナントへの費用配賦
- 複雑な計算ロジックの実装
```

##### 4. **データー移動・移動1期分** (Module14)
```
- 期間別データの配置換え
- 空調按分用のデータ整理
- J51:K84などの特定範囲処理
```

##### 5. **前年データのコピー** (Module13)
```
- 前年同月データの取得
- 比較分析用データの準備
- 計算用管理変動費Master.xlsへの転送
```

##### 6. **フードアレイ光熱費作成** (Module16)
```
- 特定テナント向けレポート
- カスタマイズされた集計処理
- 独自フォーマットでの出力
```

#### 💡 重要な特徴
- **業務プロセスの中心**: すべての月次処理がここから開始
- **複雑な計算ロジック**: 特に空調按分の処理が複雑
- **多様なデータソース**: CSV、他のExcelファイルとの連携

---

### 4. 検針結果出力ファイル.xlsx - 生データ入力

#### 📊 基本情報
- **ファイルの目的**: 検針システムからの生データ格納
- **作成元**: 外部検針システム
- **更新頻度**: 月次（検針完了後）

#### 🗂️ シート構成（全3シート）

| シート名 | データ内容 | 行数 | 備考 |
|---------|-----------|-----|-----|
| 検針結果 | 詳細検針データ | 473行 | 38列の詳細情報 |
| 計量種別 | 計量器マスター | 6行 | 計量器の種別定義 |
| テナント検針 | テナント別集計 | 693行 | 25列のテナント情報 |

#### 💡 重要な特徴
- **一次データソース**: 最も川上のデータ
- **データ量が多い**: 詳細な検針情報を保持
- **標準フォーマット**: システム出力の固定形式

---

### 5. CSVデータ群 - 外部システム連携

#### 📊 ファイル一覧

| ファイル名 | データ内容 | 用途 |
|-----------|-----------|-----|
| 16グループ別集計_*.csv | 1,6号棟データ | グループ別電気使用量 |
| 2グループ別集計_*.csv | 2号棟データ | グループ別電気使用量 |
| 78グループ別集計_*.csv | 7,8号棟データ | グループ別電気使用量 |
| 9グループ別集計_*.csv | 9号棟データ | グループ別電気使用量 |
| 集計値一覧+電力按分_*.csv | 統合集計データ | 全体集計と按分結果 |

#### 💡 重要な特徴
- **自動出力**: 検針システムからの自動生成
- **標準形式**: 決まったフォーマットで出力
- **月次更新**: ファイル名に期間情報を含む

---

## 🔄 月次業務フローとファイル間の関係

### 📅 標準的な月次処理フロー

```mermaid
flowchart TB
    A[検針システム] -->|自動出力| B[検針結果出力ファイル.xlsx]
    A -->|自動出力| C[CSVデータ群]
    
    B -->|データ取込| D[MO報告光熱費.xls]
    C -->|データ取込| D
    
    D -->|準備処理1-3| D
    D -->|空調按分計算| D
    D -->|データ転送| E[計算用管理変動費Master.xls]
    
    E -->|前月データ| E
    E -->|前年データ| E
    E -->|計算処理| E
    E -->|最終データ作成| F[管理変動費(YYYYMM).xls]
    
    D -->|特別レポート| G[フードアレイ光熱費.xls]
    
    style A fill:#f9f,stroke:#333,stroke-width:2px
    style D fill:#bbf,stroke:#333,stroke-width:4px
    style E fill:#bfb,stroke:#333,stroke-width:4px
    style F fill:#fbf,stroke:#333,stroke-width:2px
```

### 🔄 詳細な処理ステップ

#### Phase 1: データ収集（毎月1-3日）
1. **検針システムからデータ出力**
   - 検針結果出力ファイル.xlsx
   - 各種CSVファイル

2. **MO報告光熱費.xlsでデータ取込**
   - テナント検針データコピー（Module1）
   - CSVファイルからのインポート

#### Phase 2: データ加工（毎月4-5日）
3. **MO報告光熱費.xlsで準備処理**
   - 準備1: 前月データの固定化
   - 準備2: 電気データの準備
   - 準備3: 統合準備処理

4. **空調按分計算**
   - 空調使用量の按分
   - 各テナントへの配賦計算

#### Phase 3: データ統合（毎月6-7日）
5. **計算用管理変動費Master.xlsへ転送**
   - MO報告光熱費.xlsから今月データ取得
   - 前月・前年データとの統合

6. **各種計算処理**
   - 前月比・前年比計算
   - 異常値チェック

#### Phase 4: 最終処理（毎月8-10日）
7. **管理変動費(YYYYMM).xls作成**
   - 計算用Master.xlsから最終データ作成
   - 値のみで保存（数式なし）

8. **特別レポート作成**
   - フードアレイ向けレポート
   - その他カスタムレポート

---

## 💡 システム設計の特徴と課題

### ✅ 良い点
1. **役割分担が明確**
   - 各ファイルの責務が分離されている
   - データの流れが一方向

2. **履歴管理**
   - 月次ファイルで過去データ保管
   - 前月・前年比較が可能

3. **段階的処理**
   - 複雑な処理を段階的に実行
   - エラー時の影響範囲を限定

### ⚠️ 課題と改善点

1. **手動操作が多い**
   - ファイル間のデータ転送が手動
   - エラーが発生しやすい

2. **レガシー技術**
   - フロッピーディスク参照（A:\）
   - 2002年からのマクロが混在

3. **エラーハンドリング不足**
   - マクロにエラー処理がない
   - ファイル不在時に停止

4. **ハードコーディング**
   - ファイル名・パスが固定
   - 環境変更に弱い

---

## 🚀 Pleasanter移行における推奨事項

### 1. データベース設計
```
テーブル構成案:
- 検針データテーブル（生データ格納）
- 光熱費マスタテーブル（計算結果）
- テナントマスタテーブル
- 按分ルールテーブル
```

### 2. 処理の自動化
```
自動化対象:
- CSVインポート処理
- 按分計算処理
- レポート生成処理
- データ検証処理
```

### 3. 権限管理
```
ロール設定:
- 管理者: 全機能アクセス
- 入力担当: データインポートのみ
- 閲覧者: レポート参照のみ
```

### 4. 監査証跡
```
記録項目:
- データ変更履歴
- 計算処理ログ
- ユーザー操作ログ
```

---

## 📊 データ量の目安

| データ種別 | 月間レコード数 | 年間レコード数 |
|-----------|-------------|--------------|
| テナント検針データ | 約700件 | 約8,400件 |
| 電気使用データ | 約750件 | 約9,000件 |
| ガス・水道データ | 約500件 | 約6,000件 |
| 空調按分データ | 約450件 | 約5,400件 |
| **合計** | **約2,400件** | **約28,800件** |

---

## 🔄 更新履歴
| 日付 | 更新内容 | 更新者 |
|------|---------|--------|
| 2025-07-09 | 初版作成 | Claude |

---

*この分析に基づき、効率的で信頼性の高いPleasanterシステムへの移行を実現します。*