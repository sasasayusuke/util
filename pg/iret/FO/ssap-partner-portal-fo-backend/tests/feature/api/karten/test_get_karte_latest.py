import freezegun
import pytest
from fastapi.testclient import TestClient

from app.main import app
from app.models.project import ProjectModel
from app.models.project_karte import ProjectKarteModel
from app.models.user import UserModel
from app.resources.const import DataType

client = TestClient(app)


@freezegun.freeze_time("2022-08-31T22:42:05.033Z")
class TestGetKartenLatest:
    @pytest.mark.parametrize(
        "model, expected",
        [
            (
                [
                    ProjectKarteModel(
                        karte_id="8dbeeeb9-8096-4489-b497-6e33e4dabb1d",
                        project_id="886a3144-9650-4a34-8a23-3b02f3b9aeac",
                        date="2022/08/31",
                        start_datetime="2022/08/31 13:00",
                        start_time="13:00",
                        end_time="14:00",
                        supporter_ids=[],
                        draft_supporter_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        last_update_datetime="2022-07-12T02:21:39.356+0000",
                        customer_id="106a3144-9650-4a34-8a23-3b02f3b9aeac",
                        customer_user_ids=[],
                        man_hour=5,
                        detail="detail",
                        feedback="feedback",
                        homework="homework",
                        documents=[],
                        deliverables=[],
                        memo="memo",
                        task="task",
                        is_draft=False,
                        update_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        update_at="2022-07-12T02:21:39.356+0000",
                        version=2,
                    ),
                    ProjectKarteModel(
                        karte_id="8db111b9-8096-4489-b497-6e33e4dabb1d",
                        project_id="886a3144-9650-4a34-8a23-3b02f3b9aeac",
                        date="2022/09/01",
                        start_datetime="2022/09/01 13:00",
                        start_time="13:00",
                        end_time="14:00",
                        supporter_ids=[],
                        draft_supporter_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        last_update_datetime="2022-07-12T02:21:39.356+0000",
                        customer_id="106a3144-9650-4a34-8a23-3b02f3b9aeac",
                        customer_user_ids=[],
                        man_hour=5,
                        detail="detail",
                        feedback="feedback",
                        homework="homework",
                        documents=[],
                        deliverables=[],
                        memo="memo",
                        task="task",
                        is_draft=False,
                        update_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        update_at="2022-07-12T02:21:39.356+0000",
                        version=2,
                    ),
                    ProjectKarteModel(
                        karte_id="8db222b9-8096-4489-b497-6e33e4dabb1d",
                        project_id="886a3144-9650-4a34-8a23-3b02f3b9aeac",
                        date="2022/09/02",
                        start_datetime="2022/09/02 13:00",
                        start_time="13:00",
                        end_time="14:00",
                        supporter_ids=[],
                        draft_supporter_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        last_update_datetime="2022-07-12T02:21:39.356+0000",
                        customer_id="106a3144-9650-4a34-8a23-3b02f3b9aeac",
                        customer_user_ids=[],
                        man_hour=5,
                        detail="detail",
                        feedback="feedback",
                        homework="homework",
                        documents=[],
                        deliverables=[],
                        memo="memo",
                        task="task",
                        is_draft=True,
                        update_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        update_at="2022-07-12T02:21:39.356+0000",
                        version=2,
                    ),
                ],
                [
                    {
                        "karteId": "8dbeeeb9-8096-4489-b497-6e33e4dabb1d",
                        "projectId": "886a3144-9650-4a34-8a23-3b02f3b9aeac",
                        "projectName": "サンプルプロジェクト",
                        "customerName": "ソニーグループ株式会社",
                        "date": "2022/08/31",
                        "startTime": "13:00",
                        "endTime": "14:00",
                        "day": "水",
                        "lastUpdateDatetime": "2022-07-12T02:21:39.356+09:00",
                        "draftSupporterName": "テストユーザー",
                    },
                    {
                        "karteId": "8db111b9-8096-4489-b497-6e33e4dabb1d",
                        "projectId": "886a3144-9650-4a34-8a23-3b02f3b9aeac",
                        "projectName": "サンプルプロジェクト",
                        "customerName": "ソニーグループ株式会社",
                        "date": "2022/09/01",
                        "startTime": "13:00",
                        "endTime": "14:00",
                        "day": "木",
                        "lastUpdateDatetime": "2022-07-12T02:21:39.356+09:00",
                        "draftSupporterName": "テストユーザー",
                    },
                ],
            )
        ],
    )
    @pytest.mark.usefixtures("auth_customer_user")
    def test_ok(self, mocker, model, expected):
        """正常系のテスト　顧客ユーザー"""
        mock = mocker.patch.object(ProjectKarteModel, "query")
        mock.return_value = model

        # メソッド
        mock_user = mocker.patch.object(UserModel, "get")
        mock_user.return_value = UserModel(
            id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
            name="テストユーザー",
            email="sato@example.com",
            role="customer",
            customer_id="106a3144-9650-4a34-8a23-3b02f3b9aeac",
            customer_name="ソニーグループ株式会社",
            job="",
            company=None,
            supporter_organization_id=[],
            is_input_man_hour=None,
            project_ids=[],
            agreed=True,
            last_login_at="2022-04-25T03:21:39.356Z",
            disabled=False,
        )

        mock_project_get = mocker.patch.object(ProjectModel, "get")
        mock_project_get.return_value = ProjectModel(
            id="886a3144-9650-4a34-8a23-3b02f3b9aeac",
            data_type=DataType.PROJECT,
            salesforce_customer_id="c9b67094-cdab-494c-818e-d4845088269b",
            salesforce_opportunity_id="a03d1661-cdab-494c-818e-d4845088269b",
            salesforce_update_at="2020/10/23 03:21",
            customer_id="106a3144-9650-4a34-8a23-3b02f3b9aeac",
            name="サンプルプロジェクト",
            customer_name="ソニーグループ株式会社",
            service_type="7ac8bddf-88da-46c9-a504-a03d1661ad58",
            create_new=True,
            continued=True,
            main_sales_user_id="a9b67094-cdab-494c-818e-d4845088269b",
            contract_date="2021/01/30",
            phase="プラン提示(D)",
            customer_success="DXの実現",
            support_date_from="2021/01/30",
            support_date_to="2021/02/28",
            profit=[],
            total_contract_time=200,
            main_customer_user_id="b9b67094-cdab-494c-818e-d4845088269b",
            salesforce_main_customer={},
            customer_user_ids=set(list(["c9b67094-cdab-494c-818e-d4845088269b"])),
            main_supporter_user_id="c9b67094-cdab-494c-818e-d4845088269b",
            supporter_organization_id="7ac8bddf-88da-46c9-a504-a03d1661ad58",
            salesforce_main_supporter_user_name="山田太郎",
            supporter_user_ids=set(list(["c9b67094-cdab-494c-818e-d4845088269b"])),
            salesforce_supporter_user_names=["山田太郎", "山田次郎"],
            is_count_man_hour=True,
            is_karte_remind=True,
            contract_type="有償",
            is_secret=False,
            create_id="998c3cd7-63b5-453f-9de2-5af21d565b98",
            create_at="2022-05-23T16:34:21.523000+0000",
            update_id="998c3cd7-63b5-453f-9de2-5af21d565b98",
            update_at="2022-05-23T16:34:21.523000+0000",
            version=1,
        )

        response = client.get("/api/karten/latest")
        actual = response.json()

        assert response.status_code == 200
        assert actual == expected

    @pytest.mark.parametrize(
        "model_1, model_2, model_3, expected",
        [
            (
                # 案件IDが886a3144-9650-4a34-8a23-3b02f3b9aeacのカルテmodel
                [
                    ProjectKarteModel(
                        karte_id="8db111b9-8096-4489-b497-6e33e4dabb1d",
                        project_id="886a3144-9650-4a34-8a23-3b02f3b9aeac",
                        date="2022/08/24",
                        start_datetime="2022/08/24 13:00",
                        start_time="13:00",
                        end_time="14:00",
                        supporter_ids=[],
                        draft_supporter_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        last_update_datetime="2022-07-12T02:21:39.356+0000",
                        customer_id="106a3144-9650-4a34-8a23-3b02f3b9aeac",
                        customer_user_ids=[],
                        man_hour=5,
                        detail="detail",
                        feedback="feedback",
                        homework="homework",
                        documents=[],
                        deliverables=[],
                        memo="memo",
                        task="task",
                        is_draft=True,
                        update_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        update_at="2022-07-12T02:21:39.356+0000",
                        version=2,
                    ),
                    ProjectKarteModel(
                        karte_id="8db222b9-8096-4489-b497-6e33e4dabb1d",
                        project_id="886a3144-9650-4a34-8a23-3b02f3b9aeac",
                        date="2022/08/25",
                        start_datetime="2022/08/25 13:00",
                        start_time="13:00",
                        end_time="14:00",
                        supporter_ids=[],
                        draft_supporter_id=None,
                        last_update_datetime=None,
                        customer_id="106a3144-9650-4a34-8a23-3b02f3b9aeac",
                        customer_user_ids=[],
                        man_hour=0,
                        detail=None,
                        feedback=None,
                        homework=None,
                        documents=[],
                        deliverables=[],
                        memo=None,
                        task=None,
                        is_draft=True,
                        update_id="",
                        update_at="2022-07-12T02:21:39.356+0000",
                        version=1,
                    ),
                    ProjectKarteModel(
                        karte_id="8db333b9-8096-4489-b497-6e33e4dabb1d",
                        project_id="886a3144-9650-4a34-8a23-3b02f3b9aeac",
                        date="2022/08/26",
                        start_datetime="2022/08/26 13:00",
                        start_time="13:00",
                        end_time="14:00",
                        supporter_ids=[],
                        draft_supporter_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        last_update_datetime="2022-07-12T02:21:39.356+0000",
                        customer_id="106a3144-9650-4a34-8a23-3b02f3b9aeac",
                        customer_user_ids=[],
                        man_hour=5,
                        detail="detail",
                        feedback="feedback",
                        homework="homework",
                        documents=[],
                        deliverables=[],
                        memo="memo",
                        task="task",
                        is_draft=True,
                        update_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        update_at="2022-07-12T02:21:39.356+0000",
                        version=2,
                    ),
                    ProjectKarteModel(
                        karte_id="8db444b9-8096-4489-b497-6e33e4dabb1d",
                        project_id="886a3144-9650-4a34-8a23-3b02f3b9aeac",
                        date="2022/08/27",
                        start_datetime="2022/08/27 13:00",
                        start_time="13:00",
                        end_time="14:00",
                        supporter_ids=[],
                        draft_supporter_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        last_update_datetime="2022-07-12T02:21:39.356+0000",
                        customer_id="106a3144-9650-4a34-8a23-3b02f3b9aeac",
                        customer_user_ids=[],
                        man_hour=5,
                        detail="detail",
                        feedback="feedback",
                        homework="homework",
                        documents=[],
                        deliverables=[],
                        memo="memo",
                        task="task",
                        is_draft=True,
                        update_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        update_at="2022-07-12T02:21:39.356+0000",
                        version=2,
                    ),
                ],
                # 案件IDが126a3144-9650-4a34-8a23-3b02f3b9aeacのカルテmodel
                [
                    ProjectKarteModel(
                        karte_id="8db555b9-8096-4489-b497-6e33e4dabb1d",
                        project_id="126a3144-9650-4a34-8a23-3b02f3b9aeac",
                        date="2022/08/28",
                        start_datetime="2022/08/28 13:00",
                        start_time="13:00",
                        end_time="14:00",
                        supporter_ids=[],
                        draft_supporter_id=None,
                        last_update_datetime=None,
                        customer_id="106a3144-9650-4a34-8a23-3b02f3b9aeac",
                        customer_user_ids=[],
                        man_hour=0,
                        detail=None,
                        feedback=None,
                        homework=None,
                        documents=[],
                        deliverables=[],
                        memo=None,
                        task=None,
                        is_draft=True,
                        update_id="",
                        update_at="2022-07-12T02:21:39.356+0000",
                        version=1,
                    ),
                    ProjectKarteModel(
                        karte_id="8db666b9-8096-4489-b497-6e33e4dabb1d",
                        project_id="126a3144-9650-4a34-8a23-3b02f3b9aeac",
                        date="2022/08/29",
                        start_datetime="2022/08/29 13:00",
                        start_time="13:00",
                        end_time="14:00",
                        supporter_ids=[],
                        draft_supporter_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        last_update_datetime="2022-07-12T02:21:39.356+0000",
                        customer_id="106a3144-9650-4a34-8a23-3b02f3b9aeac",
                        customer_user_ids=[],
                        man_hour=5,
                        detail="detail",
                        feedback="feedback",
                        homework="homework",
                        documents=[],
                        deliverables=[],
                        memo="memo",
                        task="task",
                        is_draft=True,
                        update_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        update_at="2022-07-12T02:21:39.356+0000",
                        version=2,
                    ),
                    ProjectKarteModel(
                        karte_id="8db777b9-8096-4489-b497-6e33e4dabb1d",
                        project_id="126a3144-9650-4a34-8a23-3b02f3b9aeac",
                        date="2022/08/30",
                        start_datetime="2022/08/30 13:00",
                        start_time="13:00",
                        end_time="14:00",
                        supporter_ids=[],
                        draft_supporter_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        last_update_datetime="2022-07-12T02:21:39.356+0000",
                        customer_id="106a3144-9650-4a34-8a23-3b02f3b9aeac",
                        customer_user_ids=[],
                        man_hour=5,
                        detail="detail",
                        feedback="feedback",
                        homework="homework",
                        documents=[],
                        deliverables=[],
                        memo="memo",
                        task="task",
                        is_draft=True,
                        update_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        update_at="2022-07-12T02:21:39.356+0000",
                        version=2,
                    ),
                    ProjectKarteModel(
                        karte_id="8db888b9-8096-4489-b497-6e33e4dabb1d",
                        project_id="126a3144-9650-4a34-8a23-3b02f3b9aeac",
                        date="2022/08/31",
                        start_datetime="2022/08/31 13:00",
                        start_time="13:00",
                        end_time="14:00",
                        supporter_ids=[],
                        draft_supporter_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        last_update_datetime="2022-07-12T02:21:39.356+0000",
                        customer_id="106a3144-9650-4a34-8a23-3b02f3b9aeac",
                        customer_user_ids=[],
                        man_hour=5,
                        detail="detail",
                        feedback="feedback",
                        homework="homework",
                        documents=[],
                        deliverables=[],
                        memo="memo",
                        task="task",
                        is_draft=True,
                        update_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        update_at="2022-07-12T02:21:39.356+0000",
                        version=2,
                    ),
                ],
                # 案件IDが236a3144-9650-4a34-8a23-3b02f3b9aeacのカルテmodel
                [

                    ProjectKarteModel(
                        karte_id="8db999b9-8096-4489-b497-6e33e4dabb1d",
                        project_id="236a3144-9650-4a34-8a23-3b02f3b9aeac",
                        date="2022/09/01",
                        start_datetime="2022/09/01 13:00",
                        start_time="13:00",
                        end_time="14:00",
                        supporter_ids=[],
                        draft_supporter_id=None,
                        last_update_datetime=None,
                        customer_id="106a3144-9650-4a34-8a23-3b02f3b9aeac",
                        customer_user_ids=[],
                        man_hour=0,
                        detail=None,
                        feedback=None,
                        homework=None,
                        documents=[],
                        deliverables=[],
                        memo=None,
                        task=None,
                        is_draft=True,
                        update_id="",
                        update_at="2022-07-12T02:21:39.356+0000",
                        version=2,
                    ),
                    ProjectKarteModel(
                        karte_id="8db101010b9-8096-4489-b497-6e33e4dabb1d",
                        project_id="236a3144-9650-4a34-8a23-3b02f3b9aeac",
                        date="2022/09/02",
                        start_datetime="2022/09/02 13:00",
                        start_time="13:00",
                        end_time="14:00",
                        supporter_ids=[],
                        draft_supporter_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        last_update_datetime="2022-07-12T02:21:39.356+0000",
                        customer_id="106a3144-9650-4a34-8a23-3b02f3b9aeac",
                        customer_user_ids=[],
                        man_hour=5,
                        detail="detail",
                        feedback="feedback",
                        homework="homework",
                        documents=[],
                        deliverables=[],
                        memo="memo",
                        task="task",
                        is_draft=True,
                        update_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        update_at="2022-07-12T02:21:39.356+0000",
                        version=2,
                    ),
                    ProjectKarteModel(
                        karte_id="8db111111b9-8096-4489-b497-6e33e4dabb1d",
                        project_id="236a3144-9650-4a34-8a23-3b02f3b9aeac",
                        date="2022/08/25",
                        start_datetime="2022/08/25 14:00",
                        start_time="14:00",
                        end_time="15:00",
                        supporter_ids=[],
                        draft_supporter_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        last_update_datetime="2022-07-12T02:21:39.356+0000",
                        customer_id="106a3144-9650-4a34-8a23-3b02f3b9aeac",
                        customer_user_ids=[],
                        man_hour=5,
                        detail="detail",
                        feedback="feedback",
                        homework="homework",
                        documents=[],
                        deliverables=[],
                        memo="memo",
                        task="task",
                        is_draft=True,
                        update_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        update_at="2022-07-12T02:21:39.356+0000",
                        version=2,
                    ),
                    ProjectKarteModel(
                        karte_id="8db121212b9-8096-4489-b497-6e33e4dabb1d",
                        project_id="236a3144-9650-4a34-8a23-3b02f3b9aeac",
                        date="2022/08/26",
                        start_datetime="2022/08/26 14:00",
                        start_time="14:00",
                        end_time="15:00",
                        supporter_ids=[],
                        draft_supporter_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        last_update_datetime="2022-07-12T02:21:39.356+0000",
                        customer_id="106a3144-9650-4a34-8a23-3b02f3b9aeac",
                        customer_user_ids=[],
                        man_hour=5,
                        detail="detail",
                        feedback="feedback",
                        homework="homework",
                        documents=[],
                        deliverables=[],
                        memo="memo",
                        task="task",
                        is_draft=True,
                        update_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        update_at="2022-07-12T02:21:39.356+0000",
                        version=2,
                    ),
                ],
                # start_datetimeの降順でexpectedを定義
                [
                    {
                        "karteId": "8db999b9-8096-4489-b497-6e33e4dabb1d",
                        "projectId": "236a3144-9650-4a34-8a23-3b02f3b9aeac",
                        "projectName": "サンプルプロジェクト",
                        "customerName": "ソニーグループ株式会社",
                        "date": "2022/09/01",
                        "startTime": "13:00",
                        "endTime": "14:00",
                        "day": "木",
                        "lastUpdateDatetime": None,
                        "draftSupporterName": "",
                    },
                    {
                        "karteId": "8db888b9-8096-4489-b497-6e33e4dabb1d",
                        "projectId": "126a3144-9650-4a34-8a23-3b02f3b9aeac",
                        "projectName": "サンプルプロジェクト",
                        "customerName": "ソニーグループ株式会社",
                        "date": "2022/08/31",
                        "startTime": "13:00",
                        "endTime": "14:00",
                        "day": "水",
                        "lastUpdateDatetime": "2022-07-12T02:21:39.356+09:00",
                        "draftSupporterName": "テストユーザー",
                    },
                    {
                        "karteId": "8db777b9-8096-4489-b497-6e33e4dabb1d",
                        "projectId": "126a3144-9650-4a34-8a23-3b02f3b9aeac",
                        "projectName": "サンプルプロジェクト",
                        "customerName": "ソニーグループ株式会社",
                        "date": "2022/08/30",
                        "startTime": "13:00",
                        "endTime": "14:00",
                        "day": "火",
                        "lastUpdateDatetime": "2022-07-12T02:21:39.356+09:00",
                        "draftSupporterName": "テストユーザー",
                    },
                    {
                        "karteId": "8db666b9-8096-4489-b497-6e33e4dabb1d",
                        "projectId": "126a3144-9650-4a34-8a23-3b02f3b9aeac",
                        "projectName": "サンプルプロジェクト",
                        "customerName": "ソニーグループ株式会社",
                        "date": "2022/08/29",
                        "startTime": "13:00",
                        "endTime": "14:00",
                        "day": "月",
                        "lastUpdateDatetime": "2022-07-12T02:21:39.356+09:00",
                        "draftSupporterName": "テストユーザー",
                    },
                    {
                        "karteId": "8db555b9-8096-4489-b497-6e33e4dabb1d",
                        "projectId": "126a3144-9650-4a34-8a23-3b02f3b9aeac",
                        "projectName": "サンプルプロジェクト",
                        "customerName": "ソニーグループ株式会社",
                        "date": "2022/08/28",
                        "startTime": "13:00",
                        "endTime": "14:00",
                        "day": "日",
                        "lastUpdateDatetime": None,
                        "draftSupporterName": "",
                    },
                    {
                        "karteId": "8db444b9-8096-4489-b497-6e33e4dabb1d",
                        "projectId": "886a3144-9650-4a34-8a23-3b02f3b9aeac",
                        "projectName": "サンプルプロジェクト",
                        "customerName": "ソニーグループ株式会社",
                        "date": "2022/08/27",
                        "startTime": "13:00",
                        "endTime": "14:00",
                        "day": "土",
                        "lastUpdateDatetime": "2022-07-12T02:21:39.356+09:00",
                        "draftSupporterName": "テストユーザー",
                    },
                    {
                        "karteId": "8db121212b9-8096-4489-b497-6e33e4dabb1d",
                        "projectId": "236a3144-9650-4a34-8a23-3b02f3b9aeac",
                        "projectName": "サンプルプロジェクト",
                        "customerName": "ソニーグループ株式会社",
                        "date": "2022/08/26",
                        "startTime": "14:00",
                        "endTime": "15:00",
                        "day": "金",
                        "lastUpdateDatetime": "2022-07-12T02:21:39.356+09:00",
                        "draftSupporterName": "テストユーザー",
                    },
                    {
                        "karteId": "8db333b9-8096-4489-b497-6e33e4dabb1d",
                        "projectId": "886a3144-9650-4a34-8a23-3b02f3b9aeac",
                        "projectName": "サンプルプロジェクト",
                        "customerName": "ソニーグループ株式会社",
                        "date": "2022/08/26",
                        "startTime": "13:00",
                        "endTime": "14:00",
                        "day": "金",
                        "lastUpdateDatetime": "2022-07-12T02:21:39.356+09:00",
                        "draftSupporterName": "テストユーザー",
                    },
                    {
                        "karteId": "8db111111b9-8096-4489-b497-6e33e4dabb1d",
                        "projectId": "236a3144-9650-4a34-8a23-3b02f3b9aeac",
                        "projectName": "サンプルプロジェクト",
                        "customerName": "ソニーグループ株式会社",
                        "date": "2022/08/25",
                        "startTime": "14:00",
                        "endTime": "15:00",
                        "day": "木",
                        "lastUpdateDatetime": "2022-07-12T02:21:39.356+09:00",
                        "draftSupporterName": "テストユーザー",
                    },
                    {
                        "karteId": "8db222b9-8096-4489-b497-6e33e4dabb1d",
                        "projectId": "886a3144-9650-4a34-8a23-3b02f3b9aeac",
                        "projectName": "サンプルプロジェクト",
                        "customerName": "ソニーグループ株式会社",
                        "date": "2022/08/25",
                        "startTime": "13:00",
                        "endTime": "14:00",
                        "day": "木",
                        "lastUpdateDatetime": None,
                        "draftSupporterName": "",
                    },
                ],
            )
        ],
    )
    @pytest.mark.usefixtures("auth_supporter_user")
    def test_ok_except_customer(self, mocker, model_1, model_2, model_3, expected):
        """正常系のテスト　顧客以外のユーザー"""
        mock = mocker.patch.object(ProjectKarteModel, "query")
        mock.side_effect = [model_1, model_2, model_3]

        # メソッド
        mock_user = mocker.patch.object(UserModel, "get")
        mock_user.return_value = UserModel(
            id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
            name="テストユーザー",
            email="sato@example.com",
            role="customer",
            customer_id="106a3144-9650-4a34-8a23-3b02f3b9aeac",
            customer_name="ソニーグループ株式会社",
            job="",
            company=None,
            supporter_organization_id=[],
            is_input_man_hour=None,
            project_ids=[],
            agreed=True,
            last_login_at="2022-04-25T03:21:39.356Z",
            disabled=False,
        )

        mock_project_get = mocker.patch.object(ProjectModel, "get")
        mock_project_get.return_value = ProjectModel(
            id="886a3144-9650-4a34-8a23-3b02f3b9aeac",
            data_type=DataType.PROJECT,
            salesforce_customer_id="c9b67094-cdab-494c-818e-d4845088269b",
            salesforce_opportunity_id="a03d1661-cdab-494c-818e-d4845088269b",
            salesforce_update_at="2020/10/23 03:21",
            customer_id="106a3144-9650-4a34-8a23-3b02f3b9aeac",
            name="サンプルプロジェクト",
            customer_name="ソニーグループ株式会社",
            service_type="7ac8bddf-88da-46c9-a504-a03d1661ad58",
            create_new=True,
            continued=True,
            main_sales_user_id="a9b67094-cdab-494c-818e-d4845088269b",
            contract_date="2021/01/30",
            phase="プラン提示(D)",
            customer_success="DXの実現",
            support_date_from="2021/01/30",
            support_date_to="2021/02/28",
            profit=[],
            total_contract_time=200,
            main_customer_user_id="b9b67094-cdab-494c-818e-d4845088269b",
            salesforce_main_customer={},
            customer_user_ids=set(list(["c9b67094-cdab-494c-818e-d4845088269b"])),
            main_supporter_user_id="c9b67094-cdab-494c-818e-d4845088269b",
            supporter_organization_id="7ac8bddf-88da-46c9-a504-a03d1661ad58",
            salesforce_main_supporter_user_name="山田太郎",
            supporter_user_ids=set(list(["906a3144-9650-4a34-8a23-3b02f3b9aeac"])),
            salesforce_supporter_user_names=["山田太郎", "山田次郎"],
            is_count_man_hour=True,
            is_karte_remind=True,
            contract_type="有償",
            is_secret=False,
            create_id="998c3cd7-63b5-453f-9de2-5af21d565b98",
            create_at="2022-05-23T16:34:21.523000+0000",
            update_id="998c3cd7-63b5-453f-9de2-5af21d565b98",
            update_at="2022-05-23T16:34:21.523000+0000",
            version=1,
        )

        response = client.get("/api/karten/latest")
        actual = response.json()

        assert response.status_code == 200

        # 件数が10件かどうかをテスト
        assert len(actual) == 10
        # 比較
        assert actual == expected

    @pytest.mark.parametrize(
        "model, expected",
        [
            (
                [
                    ProjectKarteModel(
                        karte_id="8dbeeeb9-8096-4489-b497-6e33e4dabb1d",
                        project_id="2854fc20-caea-44bb-ada5",
                        date="2022/08/31",
                        start_datetime="2022/08/31 13:00",
                        start_time="13:00",
                        end_time="14:00",
                        supporter_ids=[],
                        draft_supporter_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        last_update_datetime="2022-07-12T02:21:39.356+0000",
                        customer_id="106a3144-9650-4a34-8a23-3b02f3b9aeac",
                        customer_user_ids=[],
                        man_hour=5,
                        detail="detail",
                        feedback="feedback",
                        homework="homework",
                        documents=[],
                        deliverables=[],
                        memo="memo",
                        task="task",
                        is_draft=True,
                        update_id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
                        update_at="2022-07-12T02:21:39.356+0000",
                        version=2,
                    ),
                ],
                [
                    {
                        "karteId": "8dbeeeb9-8096-4489-b497-6e33e4dabb1d",
                        "projectId": "2854fc20-caea-44bb-ada5",
                        "projectName": "サンプルプロジェクト",
                        "customerName": "ソニーグループ株式会社",
                        "date": "2022/08/31",
                        "startTime": "13:00",
                        "endTime": "14:00",
                        "day": "水",
                        "lastUpdateDatetime": "2022-07-12T02:21:39.356+09:00",
                        "draftSupporterName": "テストユーザー",
                    },
                ],
            )
        ],
    )
    @pytest.mark.usefixtures("auth_sales_mgr_user")
    def test_ng_sales_mgr(self, mocker, model, expected):
        """正常系のテスト　顧客以外のユーザー"""
        mock = mocker.patch.object(ProjectKarteModel, "query")
        mock.return_value = model

        # メソッド
        mock_user = mocker.patch.object(UserModel, "get")
        mock_user.return_value = UserModel(
            id="48501bd7-4c28-40bc-8251-3aecbf4a70ca",
            name="テストユーザー",
            email="sato@example.com",
            role="customer",
            customer_id="106a3144-9650-4a34-8a23-3b02f3b9aeac",
            customer_name="ソニーグループ株式会社",
            job="",
            company=None,
            supporter_organization_id=[],
            is_input_man_hour=None,
            project_ids=[],
            agreed=True,
            last_login_at="2022-04-25T03:21:39.356Z",
            disabled=False,
        )

        mock_project_get = mocker.patch.object(ProjectModel, "get")
        mock_project_get.return_value = ProjectModel(
            id="886a3144-9650-4a34-8a23-3b02f3b9aeac",
            data_type=DataType.PROJECT,
            salesforce_customer_id="c9b67094-cdab-494c-818e-d4845088269b",
            salesforce_opportunity_id="a03d1661-cdab-494c-818e-d4845088269b",
            salesforce_update_at="2020/10/23 03:21",
            customer_id="106a3144-9650-4a34-8a23-3b02f3b9aeac",
            name="サンプルプロジェクト",
            customer_name="ソニーグループ株式会社",
            service_type="7ac8bddf-88da-46c9-a504-a03d1661ad58",
            create_new=True,
            continued=True,
            main_sales_user_id="a9b67094-cdab-494c-818e-d4845088269b",
            contract_date="2021/01/30",
            phase="プラン提示(D)",
            customer_success="DXの実現",
            support_date_from="2021/01/30",
            support_date_to="2021/02/28",
            profit=[],
            total_contract_time=200,
            main_customer_user_id="b9b67094-cdab-494c-818e-d4845088269b",
            salesforce_main_customer={},
            customer_user_ids=set(list(["c9b67094-cdab-494c-818e-d4845088269b"])),
            main_supporter_user_id="c9b67094-cdab-494c-818e-d4845088269b",
            supporter_organization_id="7ac8bddf-88da-46c9-a504-a03d1661ad58",
            salesforce_main_supporter_user_name="山田太郎",
            supporter_user_ids=set(list(["906a3144-9650-4a34-8a23-3b02f3b9aeac"])),
            salesforce_supporter_user_names=["山田太郎", "山田次郎"],
            is_count_man_hour=True,
            is_karte_remind=True,
            contract_type="有償",
            is_secret=False,
            create_id="998c3cd7-63b5-453f-9de2-5af21d565b98",
            create_at="2022-05-23T16:34:21.523000+0000",
            update_id="998c3cd7-63b5-453f-9de2-5af21d565b98",
            update_at="2022-05-23T16:34:21.523000+0000",
            version=1,
        )

        response = client.get("/api/karten/latest")
        assert response.status_code == 403
