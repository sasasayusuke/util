# カルテ入力画面文字制限テスト仕様書

## 📋 概要

**試験ID**: FO-IT-21_26・FO-IT-21_27  
**環境**: Win/Chrome  
**対象機能**: カルテ入力・確認画面の「現状の課題・所感・申し送り」項目の1000文字制限機能

個別カルテ入力画面における「現状の課題・所感・申し送り」項目が適切に1000文字の制限を持つことを確認するテスト仕様書です。

### 現在の実装状況
- **対象フィールド**: `task` フィールド（「現状の課題・所感・申し送り」）
- **文字制限**: 1000文字（実装済み）
- **バリデーション**: フロントエンドで実装済み
- **文字カウント**: 全角・半角文字を1文字として計算

### 重要な発見
「申し送り」と「現状の課題」は**単一フィールド**として実装されており、正式名称は「現状の課題・所感・申し送り」です。

---

## 🔍 要件と現在実装の差異

| 項目 | 要件 | 現在の実装 | 状態 |
|------|------|-----------|------|
| **文字制限** | 1000文字上限 | ✅ max-length="1000" 実装済み | ✅ 実装済み |
| **バリデーション** | 制限超過時エラー表示 | ✅ バリデーション実装済み | ✅ 実装済み |
| **文字カウント表示** | 入力文字数表示 | ✅ 文字カウンター実装済み | ✅ 実装済み |
| **ロール別アクセス** | 指定ロールのみ編集可能 | ✅ 権限制御実装済み | ✅ 実装済み |

---

## 🎯 テスト目的

1. **文字制限確認**: 1000文字を超える入力時に適切にエラーが表示されることを確認
2. **境界値テスト**: 999文字、1000文字、1001文字での動作を確認
3. **文字種別テスト**: 全角・半角・特殊文字・改行等での文字カウントを確認
4. **ロール別テスト**: 各ユーザーロールでの編集権限とフィールド表示を確認
5. **保存動作確認**: 制限内・制限超過時の保存動作を確認

---

## 👥 テスト実施対象ロール

| ロール | 日本語名 | カルテ閲覧 | カルテ編集 | テスト実施 | 備考 |
|--------|----------|-----------|-----------|-----------|------|
| **supporter** | 支援者 | ✅ | ✅ | ✅ | メインテストロール |
| **supporter_mgr** | 支援者責任者 | ✅ | ✅ | ✅ | 全権限 |
| **sales** | 営業担当者 | ✅ | ❌ | ✅ | 閲覧のみ確認 |
| **sales_mgr** | 営業責任者 | ✅ | ❌ | ✅ | 閲覧のみ確認 |
| **business_mgr** | 事業責任者 | ✅ | ✅ | ⭕ | 補助的テスト |
| **customer** | 顧客 | ✅ | ❌ | ❌ | 非対象 |

---

## 📊 テスト前準備（データ作成手順）

### STEP 1: テスト用ユーザー作成

#### 1-1. 支援者（supporter）の作成
```
必要データ:
- ユーザーID: test-supporter-char-001
- 名前: 文字制限テスト支援者
- メールアドレス: char-supporter@example.com
- ロール: supporter
```

#### 1-2. 営業担当者（sales）の作成
```
必要データ:
- ユーザーID: test-sales-char-001
- 名前: 文字制限テスト営業
- メールアドレス: char-sales@example.com
- ロール: sales
```

#### 1-3. 支援者責任者（supporter_mgr）の作成
```
必要データ:
- ユーザーID: test-mgr-char-001
- 名前: 文字制限テスト責任者
- メールアドレス: char-mgr@example.com
- ロール: supporter_mgr
```

#### 1-4. 営業責任者（sales_mgr）の作成
```
必要データ:
- ユーザーID: test-salesmgr-char-001
- 名前: 文字制限テスト営業責任者
- メールアドレス: char-salesmgr@example.com
- ロール: sales_mgr
```

### STEP 2: テスト用プロジェクト作成

```
必要データ:
- プロジェクトID: test-project-char-001
- プロジェクト名: 文字制限テストプロジェクト
- 顧客名: 文字制限テスト株式会社
- 主担当支援者ID: test-supporter-char-001
- 支援開始日: 2024/01/01
- 支援終了日: 2024/12/31
- 参加メンバー: 全テストユーザーを追加
```

### STEP 3: テスト用カルテ作成

#### 3-1. 編集可能なカルテの作成
```
カルテ作成手順:
1. FO画面でスケジュール作成（test-supporter-char-001）
2. カルテ自動生成確認
3. 基本項目（お客様、支援チーム等）を入力
4. 下書き状態で保存（is_draft=true）
```

#### 3-2. テスト用文字列の準備
```javascript
// 999文字テスト用文字列
const text999 = "あ".repeat(999);

// 1000文字テスト用文字列
const text1000 = "あ".repeat(1000);

// 1001文字テスト用文字列  
const text1001 = "あ".repeat(1001);

// 混合文字テスト用文字列
const mixedText = "全角あいう123Half-width改行\n特殊文字!@#$%";
```

---

## 🧪 テストケース詳細

### 【テストケース TC-CHAR-001】文字制限基本動作確認（999文字）

#### 実施ロール: supporter（支援者）

#### 手順:
1. **FO画面にsupporterでログイン**
   - URL: `/`
   - 期待結果: HOME画面が表示される

2. **カルテ一覧画面にアクセス**
   - 操作: ヘッダー → 「カルテ管理」をクリック
   - URL: `/karte/list`
   - 期待結果: カルテ一覧画面が表示される

3. **テスト用カルテの詳細画面に遷移**
   - 操作: テスト用カルテをクリック
   - URL: `/karte/test-karte-char-001`
   - 期待結果: カルテ詳細画面が表示される

4. **編集モードに切り替え**
   - 操作: 「編集」ボタンをクリック
   - 期待結果: カルテ編集モードになる

5. **「現状の課題・所感・申し送り」フィールドを確認**
   - 確認項目: フィールドが表示されている
   - 確認項目: プレースホルダーテキストが適切に表示される
   - 期待結果: ✅ フィールドが正常に表示される

6. **999文字を入力**
   - 操作: 999文字のテスト文字列をコピー&ペースト
   - 確認項目: 文字カウンターが「999/1000」と表示される
   - 期待結果: ✅ エラーなく入力でき、文字数が正しく表示される

7. **保存動作確認**
   - 操作: 「一時保存」ボタンをクリック
   - 期待結果: ✅ 正常に保存される

#### 判定基準:
- ✅ **PASS**: 999文字が正常に入力・保存され、文字カウンターが正確
- ❌ **FAIL**: 入力できない、保存できない、または文字数表示が不正確

---

### 【テストケース TC-CHAR-002】文字制限境界値確認（1000文字）

#### 実施ロール: supporter（支援者）

#### 手順:
1. **前のテストケースから継続**
   - 前提: TC-CHAR-001の編集画面が表示されている
   
2. **1000文字に変更**
   - 操作: 現在の999文字の末尾に「あ」を1文字追加
   - 確認項目: 文字カウンターが「1000/1000」と表示される
   - 期待結果: ✅ 1000文字ちょうどが入力可能

3. **バリデーション状態確認**
   - 確認項目: エラーメッセージが表示されない
   - 確認項目: フィールドが赤色などのエラー状態にならない
   - 期待結果: ✅ バリデーションエラーなし

4. **保存動作確認**
   - 操作: 「一時保存」ボタンをクリック
   - 期待結果: ✅ 正常に保存される

5. **保存後の表示確認**
   - 操作: ページを再読み込み
   - 確認項目: 1000文字が正しく保存されている
   - 期待結果: ✅ データが欠損なく保存されている

#### 判定基準:
- ✅ **PASS**: 1000文字ちょうどが正常に入力・保存される
- ❌ **FAIL**: 1000文字で制限に引っかかる、または保存できない

---

### 【テストケース TC-CHAR-003】文字制限超過確認（1001文字）

#### 実施ロール: supporter（支援者）

#### 手順:
1. **1001文字を入力**
   - 操作: 現在の1000文字に「あ」を1文字追加
   - 期待結果: ✅ 1001文字目が入力された時点でバリデーションエラー

2. **バリデーションエラー確認**
   - 確認項目: エラーメッセージが表示される
   - 確認項目: 文字カウンターが「1001/1000」などと表示される
   - 確認項目: フィールドがエラー状態の表示になる
   - 期待結果: ✅ 適切なエラー表示

3. **エラーメッセージ内容確認**
   - 確認項目: 「1000文字以内で入力してください」などの適切なメッセージ
   - 期待結果: ✅ 分かりやすいエラーメッセージ

4. **保存ボタン動作確認**
   - 操作: 「一時保存」ボタンをクリック
   - 期待結果: ❌ 保存が実行されない、またはエラーが表示される

5. **ペースト動作確認**
   - 操作: 2000文字のテキストを一度にペースト
   - 期待結果: ✅ 1000文字まで入力され、超過分は切り捨てまたはエラー

#### 判定基準:
- ✅ **PASS**: 1001文字以上でバリデーションエラーが表示され、保存が防止される
- ❌ **FAIL**: エラーが表示されない、または1001文字以上が保存される

---

### 【テストケース TC-CHAR-004】文字種別テスト（全角・半角・特殊文字）

#### 実施ロール: supporter（支援者）

#### 手順:
1. **フィールドをクリア**
   - 操作: 現在の内容を全て削除
   - 期待結果: 空の状態になる

2. **全角文字での文字カウント確認**
   - 操作: 全角文字「あいうえお」（5文字）を入力
   - 確認項目: 文字カウンターが「5/1000」と表示される
   - 期待結果: ✅ 全角文字が1文字として計算される

3. **半角文字での文字カウント確認**
   - 操作: 半角文字「abcde」（5文字）を追加入力
   - 確認項目: 文字カウンターが「10/1000」と表示される
   - 期待結果: ✅ 半角文字も1文字として計算される

4. **特殊文字での文字カウント確認**
   - 操作: 特殊文字「!@#$%」（5文字）を追加入力
   - 確認項目: 文字カウンターが「15/1000」と表示される
   - 期待結果: ✅ 特殊文字も1文字として計算される

5. **改行文字での文字カウント確認**
   - 操作: Enterキーを押して改行を3回入力
   - 確認項目: 文字カウンターが「18/1000」と表示される
   - 期待結果: ✅ 改行も1文字として計算される

6. **混合文字での境界値テスト**
   - 操作: 全角・半角・特殊文字・改行を組み合わせて1000文字作成
   - 期待結果: ✅ 正確に1000文字として認識される

#### 判定基準:
- ✅ **PASS**: 全ての文字種別が統一的に1文字として計算される
- ❌ **FAIL**: 文字種別により計算方法が異なる

---

### 【テストケース TC-CHAR-005】営業担当者の閲覧専用確認

#### 実施ロール: sales（営業担当者）

#### 手順:
1. **FO画面にsalesでログイン**
   - URL: `/`
   - 期待結果: HOME画面が表示される

2. **カルテ詳細画面にアクセス**
   - 操作: カルテ一覧 → テスト用カルテをクリック
   - URL: `/karte/test-karte-char-001`
   - 期待結果: カルテ詳細画面が表示される

3. **編集ボタンの表示確認**
   - 確認項目: 「編集」ボタンが表示されない、または無効化されている
   - 期待結果: ✅ 営業担当者は編集できない

4. **「現状の課題・所感・申し送り」フィールドの表示確認**
   - 確認項目: フィールドの内容が読み取り専用で表示される
   - 確認項目: 入力欄ではなくテキスト表示になっている
   - 期待結果: ✅ 閲覧専用で内容が確認できる

5. **直接URL編集モードアクセス試行**
   - 操作: URL末尾に「?mode=edit」等を追加してアクセス試行
   - 期待結果: ✅ アクセス拒否または読み取り専用表示

#### 判定基準:
- ✅ **PASS**: 営業担当者は閲覧のみ可能で編集できない
- ❌ **FAIL**: 営業担当者でも編集可能

---

### 【テストケース TC-CHAR-006】営業責任者の閲覧専用確認

#### 実施ロール: sales_mgr（営業責任者）

#### 手順:
1. **FO画面にsales_mgrでログイン**
   - URL: `/`
   - 期待結果: HOME画面が表示される

2. **カルテ詳細画面での権限確認**
   - 操作: TC-CHAR-005と同様の手順を実行
   - 確認項目: 営業責任者も編集権限がないことを確認
   - 期待結果: ✅ 営業責任者も閲覧専用

#### 判定基準:
- ✅ **PASS**: 営業責任者も閲覧専用で編集不可
- ❌ **FAIL**: 営業責任者で編集可能

---

### 【テストケース TC-CHAR-007】支援者責任者の編集権限確認

#### 実施ロール: supporter_mgr（支援者責任者）

#### 手順:
1. **FO画面にsupporter_mgrでログイン**
   - URL: `/`
   - 期待結果: HOME画面が表示される

2. **カルテ編集権限の確認**
   - 操作: カルテ詳細 → 編集モード
   - 期待結果: ✅ 編集モードに切り替え可能

3. **文字制限機能の確認**
   - 操作: TC-CHAR-001〜003と同様のテストを実行
   - 期待結果: ✅ 支援者と同様に文字制限が機能する

#### 判定基準:
- ✅ **PASS**: 支援者責任者でも同様の編集権限と制限が適用される
- ❌ **FAIL**: 権限や制限に差異がある

---

### 【テストケース TC-CHAR-008】ブラウザ・IME入力テスト

#### 実施ロール: supporter（支援者）

#### 手順:
1. **日本語IME入力での文字カウント**
   - 操作: 日本語IMEで「かんじへんかんちゅう」と入力（変換前）
   - 確認項目: 変換前文字の文字カウント動作
   - 操作: 「漢字変換中」に変換
   - 期待結果: ✅ 変換後の文字数で正しくカウント

2. **コピー&ペースト動作**
   - 操作: 外部テキストから1500文字をコピー&ペースト
   - 期待結果: ✅ 1000文字まで入力され、残りは制限される

3. **ドラッグ&ドロップ動作**
   - 操作: テキストファイルをフィールドにドラッグ&ドロップ
   - 期待結果: ✅ 適切に制限が適用される

4. **音声入力動作（可能な場合）**
   - 操作: ブラウザの音声入力機能を使用
   - 期待結果: ✅ 音声入力でも文字制限が適用される

#### 判定基準:
- ✅ **PASS**: 全ての入力方法で文字制限が正常に機能する
- ❌ **FAIL**: 特定の入力方法で制限が回避される

---

## 📋 テスト実施チェックリスト

### 基本機能テスト
- [ ] TC-CHAR-001: 999文字入力・保存確認
- [ ] TC-CHAR-002: 1000文字境界値確認
- [ ] TC-CHAR-003: 1001文字制限超過確認
- [ ] TC-CHAR-004: 文字種別テスト（全角・半角・特殊文字）

### ロール別権限テスト
- [ ] TC-CHAR-005: sales（営業担当者）閲覧専用確認
- [ ] TC-CHAR-006: sales_mgr（営業責任者）閲覧専用確認
- [ ] TC-CHAR-007: supporter_mgr（支援者責任者）編集権限確認

### 入力方式テスト
- [ ] TC-CHAR-008: ブラウザ・IME入力テスト

### クロスブラウザテスト
- [ ] Chrome（推奨環境）
- [ ] Edge
- [ ] Firefox
- [ ] Safari（可能な場合）

---

## 🚨 既知の実装状況

| 項目 | 現在の実装 | 対応状況 |
|------|-----------|----------|
| **文字制限** | 1000文字制限実装済み | ✅ 実装完了 |
| **バリデーション** | エラーメッセージ表示実装済み | ✅ 実装完了 |
| **文字カウンター** | リアルタイム表示実装済み | ✅ 実装完了 |
| **ロール別権限** | 編集権限制御実装済み | ✅ 実装完了 |
| **文字種別対応** | 全文字種1文字計算実装済み | ✅ 実装完了 |

---

## 🎯 テスト完了判定基準

### ✅ 全テストPASS条件
1. **999文字・1000文字が正常に入力・保存される**
2. **1001文字以上でバリデーションエラーが表示される**
3. **全文字種で統一的な文字カウントが動作する**
4. **営業系ロールは閲覧専用、支援者系ロールは編集可能**
5. **保存が制限超過時に適切に防止される**

### ⚠️ 注意事項
1. **フィールド名**: 「申し送り」「現状の課題」は単一フィールド「現状の課題・所感・申し送り」
2. **文字計算**: 全角・半角・改行・特殊文字すべて1文字として計算
3. **ブラウザ差異**: IME入力やペースト動作でブラウザ差異の可能性

---

## 📊 テスト工数見積もり

| テスト項目 | 所要時間 | 備考 |
|-----------|----------|------|
| **データ準備** | 45分 | ユーザー・プロジェクト・カルテ作成 |
| **基本機能テスト** | 60分 | TC-CHAR-001〜004 |
| **ロール別テスト** | 45分 | TC-CHAR-005〜007 |
| **入力方式テスト** | 30分 | TC-CHAR-008 |
| **クロスブラウザ** | 60分 | 複数ブラウザでの確認 |
| **合計** | 4時間 | |

---

## 📞 問題発生時の連絡先

- **システム管理者**: [連絡先]
- **開発チーム**: [連絡先]
- **QAチーム**: [連絡先]

---

*このテスト仕様書は、FO-IT-21_26・FO-IT-21_27の試験項目に基づき、カルテ入力画面の文字制限機能の動作確認を目的としています。*
*1000文字制限は既に実装済みのため、テストは機能の正常動作確認に重点を置いて実施してください。*