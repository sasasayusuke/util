# 個別カルテ「場所」機能テスト仕様書

## 📋 概要

個別カルテ画面の「場所」機能のテスト仕様書です。
**この機能は既にシステムに実装済み**ですが、要件との差異確認とテスト手順を提供します。

---

## 🔍 要件と現在実装の差異

| 項目 | 要件 | 現在の実装 | 状態 |
|------|------|-----------|------|
| 選択肢① | オンライン | オンライン | ✅ 一致 |
| 選択肢② | 出川本社 | **品川本社** | ❌ 不一致 |
| 選択肢③ | 電話オフィス（場所を記入） | **顧客オフィス** | ❌ 不一致 |
| 選択肢④ | その他（場所を記入） | その他 | ✅ 一致 |
| テキスト入力 | ③④選択時のみ | ③④選択時のみ | ✅ 一致 |
| バリデーション | ③④で必須 | ③④で必須 | ✅ 一致 |
| 設置場所 | SAP支援チームと支援実施内容の間 | SAP支援チームと支援実施内容の間 | ✅ 一致 |
| メール通知 | 場所情報を出力 | 場所情報を出力 | ✅ 一致 |

---

## 🎯 テスト目的

1. **機能確認**: 「場所」機能が正常に動作することを確認
2. **要件差異確認**: 現在実装と要件の差異を明確にする
3. **ロール別権限確認**: 各ロールでの表示・編集権限を確認
4. **メール通知確認**: 場所情報がメールに正しく出力されることを確認

---

## 👥 テスト実施可能ロール

| ロール | 日本語名 | カルテ閲覧 | カルテ編集 | 備考 |
|--------|----------|-----------|-----------|------|
| **supporter** | 支援者 | ✅ | ✅ | 主要テストロール |
| **supporter_mgr** | 支援者責任者 | ✅ | ✅ | 全権限 |
| **business_mgr** | 事業責任者 | ✅ | ✅ | 全権限 |
| **sales** | 営業担当者 | ✅ | ❌ | 閲覧のみ |
| **customer** | 顧客 | ✅ | ❌ | 公開カルテのみ |

---

## 📊 テスト前準備（データ作成手順）

### STEP 1: テスト用ユーザー作成

#### 1-1. 支援者（supporter）の作成
```
必要データ:
- ユーザーID: test-supporter-001
- 名前: テスト支援者
- メールアドレス: test-supporter@example.com
- ロール: supporter
```

#### 1-2. 顧客（customer）の作成
```
必要データ:
- ユーザーID: test-customer-001  
- 名前: テスト顧客
- メールアドレス: test-customer@example.com
- ロール: customer
```

### STEP 2: テスト用プロジェクト作成

```
必要データ:
- プロジェクトID: test-project-location-001
- プロジェクト名: 場所機能テストプロジェクト
- 顧客名: テスト顧客株式会社
- 主担当支援者ID: test-supporter-001
- 主担当顧客ID: test-customer-001
- 支援開始日: 2024/01/01
- 支援終了日: 2024/12/31
```

### STEP 3: テスト用支援スケジュール作成

#### 3-1. FO画面でスケジュール作成
1. **FO（Front Office）に支援者でログイン**
2. **プロジェクト詳細画面にアクセス**
   - URL: `/project/test-project-location-001`
3. **支援スケジュール作成**
   - API: `POST /schedules/support/test-project-location-001`
   - パラメータ:
     ```json
     {
       "timing": "once",
       "supportDate": "2024/01/15",
       "startTime": "10:00",
       "endTime": "12:00"
     }
     ```

### STEP 4: カルテ自動生成の確認

スケジュール作成後、以下のカルテが自動生成されることを確認：
```
- カルテID: [自動生成UUID]
- プロジェクトID: test-project-location-001
- 日付: 2024/01/15
- 開始時間: 10:00
- 終了時間: 12:00
- 初期状態: is_draft=true（下書き）
```

---

## 🧪 テストケース詳細

### 【テストケース TC-LOC-001】場所フィールド表示確認

#### 実施ロール: supporter（支援者）

#### 手順:
1. **BO（Back Office）にsupporterでログイン**
2. **ヘッダーの「カルテ管理」をクリック**
   - URL: `/karte/list`
   - 期待結果: カルテ一覧画面が表示される
3. **テスト用カルテを選択してクリック**
   - URL: `/karte/{karte_id}`
   - 期待結果: カルテ詳細画面が表示される
4. **場所フィールドの表示位置を確認**
   - 確認項目: 「SAP支援チーム（敬称略）」と「支援実施内容」の間に「場所」フィールドが表示されている
   - 期待結果: ✅ 正しい位置に場所フィールドが表示される

#### 判定基準:
- ✅ **PASS**: 場所フィールドが指定位置に表示される
- ❌ **FAIL**: 場所フィールドが表示されない、または位置が違う

---

### 【テストケース TC-LOC-002】ラジオボタン選択肢確認

#### 実施ロール: supporter（支援者）

#### 手順:
1. **カルテ詳細画面で「編集」ボタンをクリック**
   - 期待結果: カルテ編集モードになる
2. **場所のラジオボタン選択肢を確認**
   - 確認項目: 
     - ① オンライン
     - ② 品川本社（※要件では「出川本社」）
     - ③ 顧客オフィス（※要件では「電話オフィス」）
     - ④ その他
3. **1つのラジオボタンのみ選択可能であることを確認**
   - 操作: 複数のラジオボタンをクリック
   - 期待結果: 最後にクリックしたもののみ選択される

#### 判定基準:
- ✅ **PASS**: 4つの選択肢が表示され、1つのみ選択可能
- ❌ **FAIL**: 選択肢が不足、または複数選択可能
- ⚠️ **要件差異**: 選択肢②③の文言が要件と異なる

---

### 【テストケース TC-LOC-003】テキスト入力フィールド動作確認

#### 実施ロール: supporter（支援者）

#### 手順:

##### 3-1. オンライン選択時のテスト
1. **「オンライン」ラジオボタンを選択**
2. **テキスト入力フィールドの状態を確認**
   - 期待結果: テキストフィールドが無効化（disabled）される
   - 期待結果: プレースホルダーが表示される

##### 3-2. 品川本社選択時のテスト
1. **「品川本社」ラジオボタンを選択**
2. **テキスト入力フィールドの状態を確認**
   - 期待結果: テキストフィールドが無効化（disabled）される

##### 3-3. 顧客オフィス選択時のテスト
1. **「顧客オフィス」ラジオボタンを選択**
2. **テキスト入力フィールドの状態を確認**
   - 期待結果: テキストフィールドが有効化される
   - 期待結果: 必須マーク（*）が表示される
3. **テキスト入力を空欄のまま保存を試行**
   - 期待結果: バリデーションエラーが表示される
4. **テキストを入力して保存**
   - 入力例: "お客様オフィス（東京都渋谷区）"
   - 期待結果: 正常に保存される

##### 3-4. その他選択時のテスト
1. **「その他」ラジオボタンを選択**
2. **テキスト入力フィールドの状態を確認**
   - 期待結果: テキストフィールドが有効化される
   - 期待結果: 必須マーク（*）が表示される
3. **テキスト入力を空欄のまま保存を試行**
   - 期待結果: バリデーションエラーが表示される
4. **最大文字数（100文字）を超える文字を入力**
   - 期待結果: 文字数制限のバリデーションエラーが表示される
5. **適切なテキストを入力して保存**
   - 入力例: "Zoomオンライン会議"
   - 期待結果: 正常に保存される

#### 判定基準:
- ✅ **PASS**: 全ての選択肢で期待通りの動作をする
- ❌ **FAIL**: バリデーションが機能しない、または予期しない動作

---

### 【テストケース TC-LOC-004】ロール別権限確認

#### 4-1. 支援者（supporter）での編集テスト

#### 手順:
1. **supporterでBO画面にログイン**
2. **カルテ詳細画面にアクセス**
3. **「編集」ボタンをクリック**
   - 期待結果: 編集モードになる
4. **場所フィールドを編集して保存**
   - 期待結果: 正常に保存される

#### 4-2. 営業担当者（sales）での閲覧テスト

#### 手順:
1. **salesでBO画面にログイン**
2. **カルテ詳細画面にアクセス**
3. **編集ボタンの表示を確認**
   - 期待結果: 編集ボタンが表示されない、または無効化される
4. **場所フィールドの表示を確認**
   - 期待結果: 場所情報が正しく表示される（閲覧可能）

#### 4-3. 顧客（customer）での閲覧テスト

#### 手順:
1. **customerでFO画面にログイン**
2. **カルテ詳細画面にアクセス**
   - 注意: 下書き状態（is_draft=true）のカルテは表示されない
3. **場所フィールドの表示を確認**
   - 期待結果: 場所情報が正しく表示される（閲覧可能）

#### 判定基準:
- ✅ **PASS**: 各ロールで期待通りの権限制御が動作する
- ❌ **FAIL**: 権限制御が機能しない

---

### 【テストケース TC-LOC-005】メール通知機能確認

#### 実施ロール: supporter（支援者）

#### 事前準備:
1. **メール送信機能が有効化されていることを確認**
2. **内部通知の送信先メールアドレスが設定されていることを確認**

#### 手順:

##### 5-1. オンライン選択時のメール確認
1. **カルテ編集画面で場所を「オンライン」に設定**
2. **その他必須項目を入力**
   - お客様: テスト顧客様
   - SAP支援チーム: テスト支援者
   - 支援実施内容: テスト内容
   - フィードバック: テストフィードバック
   - ネクストアクション: テストアクション
3. **下書きフラグをfalseに変更（確定）**
4. **保存ボタンをクリック**
5. **送信されたメールを確認**
   - 期待結果: 「【場所】オンライン」が表示される

##### 5-2. 顧客オフィス選択時のメール確認
1. **カルテ編集画面で場所を「顧客オフィス」に設定**
2. **詳細テキストに「お客様本社ビル3F会議室」を入力**
3. **保存して下書きフラグをfalseに変更**
4. **送信されたメールを確認**
   - 期待結果: 「【場所】顧客オフィス：お客様本社ビル3F会議室」が表示される

##### 5-3. その他選択時のメール確認
1. **カルテ編集画面で場所を「その他」に設定**
2. **詳細テキストに「カフェ（品川駅近く）」を入力**
3. **保存して下書きフラグをfalseに変更**
4. **送信されたメールを確認**
   - 期待結果: 「【場所】その他：カフェ（品川駅近く）」が表示される

#### 判定基準:
- ✅ **PASS**: メールに場所情報が正しく表示される
- ❌ **FAIL**: メールに場所情報が表示されない、または形式が間違っている

---

### 【テストケース TC-LOC-006】データ永続化確認

#### 実施ロール: supporter（支援者）

#### 手順:
1. **カルテに場所情報を設定して保存**
   - 設定例: 「その他」→「リモートワーク（自宅）」
2. **ブラウザを閉じて再度アクセス**
3. **同じカルテ詳細画面を開く**
4. **場所情報が保持されていることを確認**
   - 期待結果: 「その他」が選択され、「リモートワーク（自宅）」が表示される

#### 判定基準:
- ✅ **PASS**: 場所情報が正しく保存・表示される
- ❌ **FAIL**: 場所情報が失われる

---

## 📋 テスト実施チェックリスト

### 機能テスト
- [ ] TC-LOC-001: 場所フィールド表示確認
- [ ] TC-LOC-002: ラジオボタン選択肢確認
- [ ] TC-LOC-003: テキスト入力フィールド動作確認
  - [ ] 3-1: オンライン選択時
  - [ ] 3-2: 品川本社選択時
  - [ ] 3-3: 顧客オフィス選択時
  - [ ] 3-4: その他選択時
- [ ] TC-LOC-004: ロール別権限確認
  - [ ] 4-1: supporter編集テスト
  - [ ] 4-2: sales閲覧テスト
  - [ ] 4-3: customer閲覧テスト
- [ ] TC-LOC-005: メール通知機能確認
  - [ ] 5-1: オンライン選択時
  - [ ] 5-2: 顧客オフィス選択時
  - [ ] 5-3: その他選択時
- [ ] TC-LOC-006: データ永続化確認

### 要件差異確認
- [ ] 選択肢②「品川本社」→「出川本社」への変更要否
- [ ] 選択肢③「顧客オフィス」→「電話オフィス」への変更要否

---

## 🚨 既知の要件差異

| 項目 | 要件 | 現在実装 | 対応要否 |
|------|------|----------|----------|
| 選択肢② | 出川本社 | 品川本社 | 要確認 |
| 選択肢③ | 電話オフィス（場所を記入） | 顧客オフィス | 要確認 |

---

## 🎯 テスト完了判定基準

### ✅ 全テストPASS条件
1. **全機能テストケースがPASS**
2. **全ロールでの権限制御が正常動作**
3. **メール通知に場所情報が正しく出力される**
4. **データの永続化が正常動作**

### ⚠️ 要件差異について
- 現在実装は動作するが、要件と文言が異なる
- ビジネス要件に応じて修正の必要性を判断

---

## 📞 問題発生時の連絡先

- **システム管理者**: [連絡先]
- **開発チーム**: [連絡先]
- **テスト責任者**: [連絡先]

---

*このテスト仕様書は「場所」機能の動作確認と要件適合性の確認を目的としています。*
*テスト実施時は必ず事前準備を完了してから実施してください。*