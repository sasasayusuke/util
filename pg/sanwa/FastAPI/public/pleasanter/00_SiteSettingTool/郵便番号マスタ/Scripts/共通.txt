

/**
 * Null判定する関数です。
 * @param {object} obj オブジェクト
 * @returns {boolean} 判定結果
 * @throws {Error} 処理中に発生したエラー
 */
function commonIsNull(obj) {
    try {
        if (Array.isArray(obj)) {
            return obj.filter(v => String(v).trim() !== '').length == 0;
        } else if (typeof obj === 'object') {
            return !obj || Object.keys(obj).length === 0 && obj.constructor === Object;
        } else {
            return !obj && obj !== 0 || String(obj).trim() == '';
        }
    } catch (err) {
        // 再スロー
        throw err;
    }
}

/**
 * 入力されたラベルに一致する項目の選択した値を返却する。
 * @param {String} label ラベル
 * @param {Number} valueFlg 0: 値 1: 表示
 * @returns {*} 選択された値または表示テキスト
 * @throws {Error} 処理中に発生したエラー
 */
function commonGetValue(label, valueFlg = 0) {
    try {
        const control = $p.getControl($p.getColumnName(label));
        const tagName = control.prop("tagName");

        let value;

        switch (tagName) {
            case "SELECT":
                value = commonHandleSelect(control, valueFlg);
                break;
            case "INPUT":
                value = commonHandleInput(control, label, valueFlg);
                break;
            case "TEXTAREA":
                value = document.getElementById(commonGetId(label) + ".viewer").innerText;
                break;
            default:
                value = commonHandleDefault(control, valueFlg);
        }

        return commonParseIfJson(value);
    } catch (err) {
        // 再スロー
        throw err;
    }
}

/**
 * 入力されたラベルのIDを返却する。
 * @param {String} label ラベル
 * @param {Boolean} [prefix=true] プレフィックス（テーブル名）を付けるかどうか
 * @param {Boolean} [suffix=false] サフィックス（'Field'）を付けるかどうか
 * @returns {String} 生成されたID
 * @throws {Error} ラベルが不正な場合やその他のエラー
 */
function commonGetId(label, prefix = true, suffix = false) {
    try {
        let id = $p.getColumnName(label);
        if (commonIsNull(id)) {
            throw new Error(`共通関数commonGetId：ラベル不正。${label}`);
        }
        id = prefix ? `${$p.tableName()}_${id}` : id;
        id = suffix ? `${id}Field` : id;
        return id;
    } catch (err) {
        // 再スロー
        throw err;
    }
}

/**
 * SELECT要素の値を処理する。
 * @param {jQuery} control jQuery対象のSELECT要素
 * @param {Number} valueFlg 0: 値 1: 表示
 * @returns {*} 選択された値または表示テキスト
 * @throws {Error} 処理中に発生したエラー
 */
function commonHandleSelect(control, valueFlg) {
    try {
        if (control.attr("multiple")) {
            return valueFlg === 0 ? control.val() : control.next().children().last().text();
        }
        const selectedOption = control.children(':selected');
        return valueFlg === 0 ? selectedOption.val() : selectedOption.text();
    } catch (err) {
        // 再スロー
        throw err;
    }
}

/**
 * INPUT要素の値を処理する。
 * @param {jQuery} control jQuery対象のINPUT要素
 * @param {String} label ラベル
 * @param {Number} valueFlg 0: 値 1: 表示
 * @returns {*} 入力された値または表示テキスト
 * @throws {Error} 処理中に発生したエラー
 */
function commonHandleInput(control, label, valueFlg) {
    try {
        const inputId = commonGetId(label);
        if (inputId.indexOf("Check") > 0) {
            const checked = document.getElementById(inputId).checked;
            return valueFlg === 0 ? +checked : checked;
        }
        let value = valueFlg === 0 ? control.attr('data-value') : control[0].innerHTML;
        return commonIsNull(value) ? control.val() : value;
    } catch (err) {
        // 再スロー
        throw err;
    }
}

/**
 * デフォルトの要素処理を行う。
 * @param {jQuery} control jQuery対象の要素
 * @param {Number} valueFlg 0: 値 1: 表示
 * @returns {*} 要素の値または表示テキスト
 * @throws {Error} 処理中に発生したエラー
 */
function commonHandleDefault(control, valueFlg) {
    try {
        let value = valueFlg === 0 ? (control.attr('data-value') ?? control[0].innerHTML) : control[0].innerHTML;
        return commonIsNull(value) ? control.val() : value;
    } catch (err) {
        // 再スロー
        throw err;
    }
}

/**
 * 値がJSON文字列の場合はパースし、そうでない場合は元の値を返す。
 * @param {*} value パース対象の値
 * @returns {*} パースされた値または元の値
 * @throws {Error} JSON.parse()で発生したエラー（ただし、通常は捕捉されて元の値が返される）
 */
function commonParseIfJson(value) {
    if (typeof value !== 'string') return value;
    try {
        return JSON.parse(value);
    } catch (err) {
        return value;
    }
}

/**
 * 指定された文言と完全に一致する最初のリンクを検索し、href属性を'#'に変更して、クリック時にカスタム関数を実行する関数
 * @param {string} searchText - リンクを検索するための文言（完全一致）
 * @param {function} customClickHandler - クリック時に実行されるカスタム関数
 * @returns {boolean} - リンクが見つかって修正されたかどうか
 * @throws {Error} 処理中に発生したエラー
 */
function commonModifyLink(searchText, customClickHandler) {
    try {
        const link = Array.from(document.getElementsByTagName('a')).find(a =>
            a.textContent.trim() === searchText.trim()
        );

        if (link) {
            const dataValue = link.closest('[data-value]')?.getAttribute('data-value');
            link.setAttribute('href', '#');
            link.onclick = function(event) {
                event.preventDefault();
                customClickHandler(dataValue, link.textContent);
                return false;
            };
            return true;
        } else {
            console.warn(`"${searchText}" と完全に一致するリンクが見つかりませんでした。`);
            return false;
        }
    } catch (err) {
        // 再スロー
        throw err;
    }
}

/**
 * コマンドエリアにボタンを追加する関数です。
 * @param {String} buttonId     ボタンID
 * @param {Function} clickFunc  click時関数
 * @param {String} label        ラベル
 * @param {String} title        タイトル
 * @param {String} style        スタイル
 * @param {String} icon         アイコン（empty指定でアイコンなし）
 * @param {String} appendId     appendする要素ID
 * @param {Array} applys        適用するステータス
 * @throws {Error} 処理中に発生したエラー
 */
function commonAddButton(buttonId, clickFunc, label, title, style, icon = "ui-icon-disk", appendId = "MainCommands", applys = "all") {
    try {
        if (!commonCheckStatus(applys)) return;

        const target = document.getElementById(appendId);
        const elem = document.createElement('button');
        elem.id = buttonId;
        elem.className = 'button button-icon ui-button ui-corner-all ui-widget applied';
        elem.onclick = clickFunc;
        if (!commonIsNull(title)) elem.title = title;
        if (!commonIsNull(style)) elem.style = style;
        elem.innerText = label;
        if (icon !== "empty") {
            const span = document.createElement('span');
            span.className = `ui-button-icon ui-icon ${icon}`;
            elem.appendChild(span);
        }
        const space = document.createElement('span');
        space.className = "ui-button-icon-space";
        elem.appendChild(space);

        target.appendChild(elem);
    } catch (err) {
        // 再スロー
        throw err;
    }
}

/**
 * ステータスをチェックする関数です。
 * @param {Array|string} applys 適用するステータス
 * @returns {boolean} チェック結果
 * @throws {Error} 処理中に発生したエラー
 */
function commonCheckStatus(applys = "all") {
    try {
        let allFlg = false;
        if (!Array.isArray(applys)) {
            if (applys === "all") {
                allFlg = true;
            } else {
                applys = [applys];
            }
        }
        return allFlg || applys.map(v => +v).includes(+commonGetValue("Status", true));
    } catch (err) {
        // 再スロー
        throw err;
    }
}
