# 按分経費集計表の集計数字差異の原因分析

## 問題の概要
「租税公課」「受取利息」「受取配当金」「支払利息」の金額が新旧システムで異なる

## 調査結果

### 1. 按分処理の仕組み（usp_KD0801経費按分データ作成V7）

按分処理では以下のテーブルを使用：
- TD経費・TD経費明細：経費データ
- TM業種按分：配員数による按分比率
- TM補助科目：補助CDによる部門分け

### 2. 問題の原因：補助CDの扱いの違い

#### 旧システム（VB6）の補助CD処理
```vb
' 借方側
.Fields("補助CD") = SpcToNull(cTable(i)(11), 0)  ' 財務応援担当者CD

' 貸方側  
.Fields("補助CD") = SpcToNull(cTable(i)(20), 0)  ' 貸方の補助CD
```

#### 新システム（Python）の補助CD処理
```python
# 借方側
gRsA_dic['補助CD'] = SpcToNull(csvData[10],0)  # 配列位置が-1ずれている

# 貸方側
gRsA_dic['補助CD'] = SpcToNull(csvData[19],0)  # 配列位置が-1ずれている
```

### 3. 按分処理への影響

usp_KD0801経費按分データ作成V7の処理を見ると：

```sql
-- 業種按分の処理（163行目付近）
SELECT KM.科目CD, KM.補助CD, KM.科目名, SUM(KM.金額) AS 金額 
FROM TD経費 AS KH  
    INNER JOIN TD経費明細 AS KM ON KH.経費番号 = KM.経費番号
WHERE KH.経費日付 >= @iS集計日付 
    AND KH.経費日付 <= @iE集計日付 
GROUP BY KM.科目CD, KM.補助CD, KM.科目名
```

**補助CDでグループ化されている**ため、補助CDの値が異なると別々に集計される。

### 4. 根本原因の特定

1. **CSV配列インデックスのずれ**
   - VB6：1ベース（11番目、20番目）
   - Python：0ベース（10番目、19番目）
   - これ自体は一貫して-1なので問題ない

2. **補助CDの意味の違い** ⚠️ **これが原因の可能性大**
   - 旧システム：借方は「財務応援担当者CD」を補助CDとして使用
   - 新システム：そのまま補助CDとして使用
   
   特に問題となるのは：
   - csvData[10]（Python）/ cTable(i)(11)（VB6）が同じ「財務応援担当者CD」を指しているか
   - これが科目によって異なる値になっている可能性

3. **担当者CDがnullの影響**
   - 直接的には按分処理に影響しないが、補助CDの値に関連している可能性

### 5. 推奨される対処法

1. **CSVデータの確認**
   ```python
   # デバッグ用：CSVデータの内容を確認
   logger.debug(f"借方補助CD位置[10]: {csvData[10]}")
   logger.debug(f"貸方補助CD位置[19]: {csvData[19]}")
   ```

2. **補助CDマッピングの修正**
   - 「租税公課」「受取利息」「受取配当金」「支払利息」の科目で補助CDがどのような値になっているか確認
   - 財務応援担当者CDと補助CDの関係を明確化

3. **テスト方法**
   - 同じCSVデータを新旧システムで取り込み
   - TD経費明細の補助CDの値を比較
   - 按分処理後の結果を比較

## 結論

按分経費集計表の差異は、**補助CDの値の違い**が原因である可能性が高い。特に：

1. CSVデータの補助CD位置が正しくマッピングされているか
2. 財務応援担当者CDを補助CDとして使用する仕様が新システムで正しく実装されているか

これらを確認・修正することで、集計結果の差異を解消できると考えられる。